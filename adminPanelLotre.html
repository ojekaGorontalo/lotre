<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel - Tebak Besar Kecil & Tebak Angka</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #d70000 0%, #8b0000 100%);
            min-height: 100vh;
        }
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h2 {
            color: #d70000;
            text-align: center;
            margin-bottom: 30px;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: #f5f5f5;
            color: #666;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .tab-btn:hover {
            background: #e9e9e9;
        }
        .tab-btn.active {
            background: #d70000;
            color: white;
            border-color: #d70000;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .mode-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .mode-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            border: 2px solid #d70000;
            background: white;
            color: #d70000;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .mode-btn:hover {
            background: #ffe6e6;
        }
        .mode-btn.active {
            background: #d70000;
            color: white;
        }
        .mode-btn.angka-mode {
            border-color: #0066cc;
            color: #0066cc;
        }
        .mode-btn.angka-mode:hover {
            background: #e6f0ff;
        }
        .mode-btn.angka-mode.active {
            background: #0066cc;
            color: white;
        }
        .input-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        input:focus, select:focus {
            border-color: #d70000;
            outline: none;
        }
        button {
            background: #d70000;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
            margin-top: 10px;
        }
        button:hover {
            background: #b30000;
        }
        button.angka-btn {
            background: #0066cc;
        }
        button.angka-btn:hover {
            background: #0055aa;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .live-monitor {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #ddd;
        }
        .live-monitor h3 {
            color: #d70000;
            margin-bottom: 15px;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .history-table th, .history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .history-table th {
            background: #e9ecef;
            color: #333;
        }
        .stat-box {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #d70000;
            margin: 5px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        .bet-monitor {
            margin-top: 30px;
        }
        .bet-monitor h4 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #d70000;
        }
        .bet-cards {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .bet-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-top: 4px solid;
            text-align: center;
        }
        .bet-card.angka-0 { border-top-color: #FF6B6B; }
        .bet-card.angka-1 { border-top-color: #4ECDC4; }
        .bet-card.angka-2 { border-top-color: #FFD166; }
        .bet-card.angka-3 { border-top-color: #06D6A0; }
        .bet-card.angka-4 { border-top-color: #118AB2; }
        .bet-card.angka-5 { border-top-color: #EF476F; }
        .bet-card.angka-6 { border-top-color: #7209B7; }
        .bet-card.angka-7 { border-top-color: #F8961E; }
        .bet-card.angka-8 { border-top-color: #43AA8B; }
        .bet-card.angka-9 { border-top-color: #277DA1; }
        .bet-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .bet-title.angka-0 { color: #FF6B6B; }
        .bet-title.angka-1 { color: #4ECDC4; }
        .bet-title.angka-2 { color: #FFD166; }
        .bet-title.angka-3 { color: #06D6A0; }
        .bet-title.angka-4 { color: #118AB2; }
        .bet-title.angka-5 { color: #EF476F; }
        .bet-title.angka-6 { color: #7209B7; }
        .bet-title.angka-7 { color: #F8961E; }
        .bet-title.angka-8 { color: #43AA8B; }
        .bet-title.angka-9 { color: #277DA1; }
        .bet-info {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .bet-info-item {
            text-align: center;
        }
        .bet-number {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        .bet-label {
            font-size: 12px;
            color: #666;
        }
        .max-bet {
            background: #fff3cd;
            border-radius: 6px;
            padding: 10px;
            margin-top: 15px;
            text-align: center;
            border: 1px solid #ffeaa7;
        }
        .max-bet-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .max-bet-user {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .current-round {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #bbdefb;
        }
        .current-round h5 {
            color: #1976d2;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .no-data {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }
        #start-round-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
            margin-top: 10px;
        }
        #start-round-btn:hover {
            background: #218838;
        }
        #force-result-btn {
            background: #ff9900;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
            margin-top: 10px;
        }
        #force-result-btn:hover {
            background: #e68900;
        }
        .admin-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        .round-history {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
        }
        .round-history-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        .round-history-item.win {
            background: rgba(40, 167, 69, 0.1);
        }
        .round-history-item.lose {
            background: rgba(220, 53, 69, 0.1);
        }
        .hasil-controls {
            background: #f0f7ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .hasil-controls-title {
            font-size: 16px;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 10px;
        }
        .hasil-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        .hasil-btn {
            background: white;
            border: 2px solid #0066cc;
            color: #0066cc;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .hasil-btn:hover {
            background: #e6f0ff;
        }
        .hasil-btn.active {
            background: #0066cc;
            color: white;
        }
        .selected-hasil {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #333;
            font-size: 18px;
        }
        .selected-hasil span {
            color: #d70000;
        }
        .game-type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .game-type-bk {
            background: #ffcccc;
            color: #d70000;
        }
        .game-type-ta {
            background: #cce5ff;
            color: #0066cc;
        }
        .angka-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #ddd;
        }
        .angka-info h4 {
            color: #0066cc;
            margin-bottom: 10px;
        }
        .angka-rules {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .rule-item {
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }
        .rule-item.besar {
            background: rgba(215, 0, 0, 0.1);
            color: #d70000;
            border: 1px solid rgba(215, 0, 0, 0.2);
        }
        .rule-item.kecil {
            background: rgba(0, 102, 204, 0.1);
            color: #0066cc;
            border: 1px solid rgba(0, 102, 204, 0.2);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h2>‚öôÔ∏è ADMIN PANEL - TEBAK BESAR/KECIL & TEBAK ANGKA</h2>
        
        <div class="tab-container">
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('besar-kecil')">üéØ Tebak Besar/Kecil</button>
                <button class="tab-btn" onclick="showTab('angka')">üî¢ Tebak Angka (0-9)</button>
            </div>
            
            <!-- TAB TEBAK BESAR/KECIL -->
            <div id="tab-besar-kecil" class="tab-content active">
                <div class="input-group">
                    <label>Mode Permainan Besar/Kecil:</label>
                    <div class="mode-buttons">
                        <button class="mode-btn" onclick="setModeBk('random_bk')" id="btn-random-bk">RANDOM</button>
                        <button class="mode-btn" onclick="setModeBk('harus_besar')" id="btn-besar">HARUS BESAR</button>
                        <button class="mode-btn" onclick="setModeBk('harus_kecil')" id="btn-kecil">HARUS KECIL</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Waktu Tunggu (detik):</label>
                    <input type="number" id="waktuTungguBk" value="15" min="5" max="60">
                </div>
                
                <div class="input-group">
                    <label>Pasangan (pisahkan dengan koma):</label>
                    <input type="text" id="pasanganBk" value="1000,2000,5000,10000,20000" placeholder="Contoh: 1000,2000,5000">
                </div>
                
                <!-- Kontrol Hasil Besar/Kecil -->
                <div class="hasil-controls">
                    <div class="hasil-controls-title">Tentukan Hasil Round Besar/Kecil:</div>
                    
                    <div class="hasil-buttons">
                        <button class="hasil-btn" onclick="setHasilBesarKecil('BESAR')" id="btn-hasil-besar">BESAR</button>
                        <button class="hasil-btn" onclick="setHasilBesarKecil('KECIL')" id="btn-hasil-kecil">KECIL</button>
                    </div>
                    
                    <div class="selected-hasil">
                        Hasil Terpilih: <span id="selected-hasil-bk-text">-</span>
                    </div>
                </div>
                
                <div class="admin-controls">
                    <button onclick="saveSettingsBk()">üíæ SIMPAN PENGATURAN BESAR/KECIL</button>
                    <button onclick="forceResetGameBk()" style="background: #ff9900;">üîÑ RESET PERMAINAN BESAR/KECIL</button>
                </div>
                
                <button id="start-round-btn-bk" onclick="startNewRoundBk()">üöÄ MULAI ROUND BESAR/KECIL</button>
                <button id="force-result-btn-bk" onclick="forceRoundResultBk()">üéØ TENTUKAN HASIL BESAR/KECIL</button>
                
                <div id="status-bk" class="status"></div>
                
                <div class="live-monitor">
                    <h3>üìä LIVE MONITOR BESAR/KECIL</h3>
                    <div class="stat-box">
                        <div class="stat-item">
                            <div class="stat-label">Mode Saat Ini</div>
                            <div class="stat-value" id="current-mode-bk">RANDOM</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Waktu Tunggu</div>
                            <div class="stat-value" id="current-timer-bk">15 detik</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Status Engine</div>
                            <div class="stat-value" id="engine-status-bk">AKTIF</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Round Aktif</div>
                            <div class="stat-value" id="active-round-count-bk">0</div>
                        </div>
                    </div>
                    
                    <!-- Current Round Bet Monitoring -->
                    <div class="bet-monitor">
                        <h4>üé≤ MONITORING TARUHAN ROUND SAAT INI <span class="game-type-badge game-type-bk">BESAR/KECIL</span></h4>
                        <div class="current-round">
                            <h5>Round ID: <span id="current-round-id-bk">-</span></h5>
                            <div>Status: <span id="current-round-status-bk">-</span></div>
                            <div>Waktu Tersisa: <span id="current-round-timer-bk">-</span></div>
                            <div>Mode: <span id="current-round-mode-bk">-</span></div>
                        </div>
                        
                        <div class="bet-cards">
                            <div class="bet-card besar">
                                <div class="bet-title">üü• BESAR (5-9)</div>
                                <div class="bet-info">
                                    <div class="bet-info-item">
                                        <div class="bet-number" id="besar-count">0</div>
                                        <div class="bet-label">Jumlah User</div>
                                    </div>
                                    <div class="bet-info-item">
                                        <div class="bet-number" id="besar-total">0</div>
                                        <div class="bet-label">Total Pasangan</div>
                                    </div>
                                </div>
                                <div class="max-bet">
                                    <div class="bet-label">Taruhan Terbesar</div>
                                    <div class="max-bet-value" id="besar-max">-</div>
                                    <div class="max-bet-user" id="besar-max-user">-</div>
                                </div>
                            </div>
                            
                            <div class="bet-card kecil">
                                <div class="bet-title">üü¶ KECIL (0-4)</div>
                                <div class="bet-info">
                                    <div class="bet-info-item">
                                        <div class="bet-number" id="kecil-count">0</div>
                                        <div class="bet-label">Jumlah User</div>
                                    </div>
                                    <div class="bet-info-item">
                                        <div class="bet-number" id="kecil-total">0</div>
                                        <div class="bet-label">Total Pasangan</div>
                                    </div>
                                </div>
                                <div class="max-bet">
                                    <div class="bet-label">Taruhan Terbesar</div>
                                    <div class="max-bet-value" id="kecil-max">-</div>
                                    <div class="max-bet-user" id="kecil-max-user">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h5>üë• DETAIL TARUHAN USER</h5>
                            <div id="bet-details-bk" class="no-data">Belum ada taruhan</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>üìã HISTORY HASIL BESAR/KECIL (10 Terakhir)</h4>
                        <div id="result-history-bk" class="round-history"></div>
                    </div>
                </div>
            </div>
            
            <!-- TAB TEBAK ANGKA -->
            <div id="tab-angka" class="tab-content">
                <div class="angka-info">
                    <h4>üìä ATURAN TEBAK ANGKA:</h4>
                    <div class="angka-rules">
                        <div class="rule-item kecil">
                            üîµ KECIL: Angka 0, 1, 2, 3, 4
                        </div>
                        <div class="rule-item besar">
                            üî¥ BESAR: Angka 5, 6, 7, 8, 9
                        </div>
                    </div>
                    <p style="margin-top: 10px; font-size: 14px; color: #666;">
                        User memilih angka spesifik (0-9). Hasil akan ditentukan oleh admin.
                    </p>
                </div>
                
                <div class="input-group">
                    <label>Mode Permainan Tebak Angka:</label>
                    <div class="mode-buttons">
                        <button class="mode-btn angka-mode" onclick="setModeAngka('random_angka')" id="btn-random-angka">RANDOM ANGKA</button>
                        <button class="mode-btn angka-mode" onclick="setModeAngka('harus_besar')" id="btn-besar-angka">HARUS BESAR (5-9)</button>
                        <button class="mode-btn angka-mode" onclick="setModeAngka('harus_kecil')" id="btn-kecil-angka">HARUS KECIL (0-4)</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Waktu Tunggu (detik):</label>
                    <input type="number" id="waktuTungguAngka" value="15" min="5" max="60">
                </div>
                
                <div class="input-group">
                    <label>Pasangan (pisahkan dengan koma):</label>
                    <input type="text" id="pasanganAngka" value="1000,2000,5000,10000,20000" placeholder="Contoh: 1000,2000,5000">
                </div>
                
                <!-- Kontrol Hasil Angka -->
                <div class="hasil-controls">
                    <div class="hasil-controls-title">Tentukan Hasil Angka (0-9):</div>
                    
                    <div class="hasil-buttons">
                        <button class="hasil-btn" onclick="setHasilAngka(0)" id="btn-hasil-0">0</button>
                        <button class="hasil-btn" onclick="setHasilAngka(1)" id="btn-hasil-1">1</button>
                        <button class="hasil-btn" onclick="setHasilAngka(2)" id="btn-hasil-2">2</button>
                        <button class="hasil-btn" onclick="setHasilAngka(3)" id="btn-hasil-3">3</button>
                        <button class="hasil-btn" onclick="setHasilAngka(4)" id="btn-hasil-4">4</button>
                        <button class="hasil-btn" onclick="setHasilAngka(5)" id="btn-hasil-5">5</button>
                        <button class="hasil-btn" onclick="setHasilAngka(6)" id="btn-hasil-6">6</button>
                        <button class="hasil-btn" onclick="setHasilAngka(7)" id="btn-hasil-7">7</button>
                        <button class="hasil-btn" onclick="setHasilAngka(8)" id="btn-hasil-8">8</button>
                        <button class="hasil-btn" onclick="setHasilAngka(9)" id="btn-hasil-9">9</button>
                    </div>
                    
                    <div class="selected-hasil">
                        Hasil Angka Terpilih: <span id="selected-hasil-angka-text">-</span>
                        <span id="selected-hasil-kategori" style="margin-left: 10px; font-size: 14px;"></span>
                    </div>
                </div>
                
                <div class="admin-controls">
                    <button class="angka-btn" onclick="saveSettingsAngka()">üíæ SIMPAN PENGATURAN TEBAK ANGKA</button>
                    <button onclick="forceResetGameAngka()" style="background: #ff9900;">üîÑ RESET PERMAINAN TEBAK ANGKA</button>
                </div>
                
                <button class="angka-btn" id="start-round-btn-angka" onclick="startNewRoundAngka()">üöÄ MULAI ROUND TEBAK ANGKA</button>
                <button id="force-result-btn-angka" onclick="forceRoundResultAngka()" style="background: #0066cc;">üéØ TENTUKAN HASIL TEBAK ANGKA</button>
                
                <div id="status-angka" class="status"></div>
                
                <div class="live-monitor">
                    <h3>üìä LIVE MONITOR TEBAK ANGKA</h3>
                    <div class="stat-box">
                        <div class="stat-item">
                            <div class="stat-label">Mode Saat Ini</div>
                            <div class="stat-value" id="current-mode-angka">RANDOM ANGKA</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Waktu Tunggu</div>
                            <div class="stat-value" id="current-timer-angka">15 detik</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Status Engine</div>
                            <div class="stat-value" id="engine-status-angka">AKTIF</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Round Aktif</div>
                            <div class="stat-value" id="active-round-count-angka">0</div>
                        </div>
                    </div>
                    
                    <!-- Current Round Bet Monitoring -->
                    <div class="bet-monitor">
                        <h4>üé≤ MONITORING TARUHAN ROUND SAAT INI <span class="game-type-badge game-type-ta">TEBAK ANGKA 0-9</span></h4>
                        <div class="current-round">
                            <h5>Round ID: <span id="current-round-id-angka">-</span></h5>
                            <div>Status: <span id="current-round-status-angka">-</span></div>
                            <div>Waktu Tersisa: <span id="current-round-timer-angka">-</span></div>
                            <div>Mode: <span id="current-round-mode-angka">-</span></div>
                        </div>
                        
                        <div class="angka-info" style="margin-bottom: 20px;">
                            <div class="angka-rules">
                                <div class="rule-item kecil" style="flex: 1;">
                                    üîµ KECIL (0-4)
                                </div>
                                <div class="rule-item besar" style="flex: 1;">
                                    üî¥ BESAR (5-9)
                                </div>
                            </div>
                        </div>
                        
                        <div class="bet-cards">
                            <!-- Angka 0-9 akan ditampilkan di sini -->
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h5>üë• DETAIL TARUHAN USER</h5>
                            <div id="bet-details-angka" class="no-data">Belum ada taruhan</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>üìã HISTORY HASIL TEBAK ANGKA (10 Terakhir)</h4>
                        <div id="result-history-angka" class="round-history"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDtZxsl5LZp3n1KZJfdVAdqQj22ZBPoQbU",
            authDomain: "steady-fin-368617.firebaseapp.com",
            databaseURL: "https://steady-fin-368617-default-rtdb.firebaseio.com",
            projectId: "steady-fin-368617",
            storageBucket: "steady-fin-368617.firebasestorage.app",
            messagingSenderId: "626971902484",
            appId: "1:626971902484:web:98f7cdbd55c5990dfe9d01",
            measurementId: "G-70D3LR995Y"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // State untuk game Besar/Kecil
        let currentModeBk = 'random_bk';
        let currentGameIntervalBk = null;
        let activeRoundIdBk = null;
        let selectedHasilBesarKecil = null;
        
        // State untuk game Tebak Angka
        let currentModeAngka = 'random_angka';
        let currentGameIntervalAngka = null;
        let activeRoundIdAngka = null;
        let selectedHasilAngka = null;

        // ==================== FUNGSI GENERATE ROUND ID ====================
        let roundCounter = 99999; // Counter 5 digit, dimulai dari 99999

        function generateRoundId() {
            // Ambil timestamp saat ini (milidetik sejak epoch)
            const timestamp = Date.now(); // 13 digit
            
            // Format: timestamp (13 digit) + counter (5 digit) = 18 digit
            // Counter akan berkurang setiap pembuatan round
            const roundId = timestamp.toString() + roundCounter.toString().padStart(5, '0');
            
            // Kurangi counter untuk round berikutnya
            roundCounter--;
            
            // Jika counter sudah habis, reset ke 99999
            if (roundCounter < 0) {
                roundCounter = 99999;
            }
            
            return roundId;
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Activate selected tab button
            document.querySelector(`.tab-btn[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            // Load data for the selected tab
            if (tabName === 'besar-kecil') {
                loadBkSettings();
            } else if (tabName === 'angka') {
                loadAngkaSettings();
            }
        }

        // ==================== FUNGSI UNTUK GAME BESAR/KECIL ====================

        function setModeBk(mode) {
            currentModeBk = mode;
            updateModeButtonsBk();
        }

        function updateModeButtonsBk() {
            // Reset semua button
            document.querySelectorAll('.mode-btn:not(.angka-mode)').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = '#d70000';
            });
            
            // Aktifkan button yang sesuai
            let btnId = '';
            if (currentModeBk === 'random_bk') btnId = 'btn-random-bk';
            else if (currentModeBk === 'harus_besar') btnId = 'btn-besar';
            else if (currentModeBk === 'harus_kecil') btnId = 'btn-kecil';
            
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.classList.add('active');
                btn.style.background = '#d70000';
                btn.style.color = 'white';
            }
        }

        function setHasilBesarKecil(hasil) {
            selectedHasilBesarKecil = hasil;
            updateHasilButtonsBk();
        }

        function updateHasilButtonsBk() {
            // Reset semua button hasil
            document.querySelectorAll('.hasil-btn').forEach(btn => {
                if (btn.id.startsWith('btn-hasil-besar') || btn.id.startsWith('btn-hasil-kecil')) {
                    btn.classList.remove('active');
                    btn.style.background = 'white';
                    btn.style.color = '#0066cc';
                }
            });
            
            // Aktifkan button yang sesuai
            if (selectedHasilBesarKecil) {
                const btn = document.getElementById(`btn-hasil-${selectedHasilBesarKecil.toLowerCase()}`);
                if (btn) {
                    btn.classList.add('active');
                    btn.style.background = '#0066cc';
                    btn.style.color = 'white';
                }
            }
            
            document.getElementById('selected-hasil-bk-text').textContent = 
                selectedHasilBesarKecil ? selectedHasilBesarKecil : '-';
        }

        async function loadBkSettings() {
            try {
                const snapshot = await database.ref('tebak-angka/aturan').once('value');
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    currentModeBk = data.mode || 'random_bk';
                    updateModeButtonsBk();
                    document.getElementById('waktuTungguBk').value = data.waktu_tunggu || 15;
                    document.getElementById('current-mode-bk').textContent = currentModeBk.toUpperCase();
                    document.getElementById('current-timer-bk').textContent = (data.waktu_tunggu || 15) + ' detik';
                    
                    // Auto-start game engine jika belum berjalan
                    if (data.aktif && !currentGameIntervalBk) {
                        startGameEngineBk();
                    }
                }
            } catch (error) {
                console.error("Error loading BK settings:", error);
            }
        }

        async function saveSettingsBk() {
            const waktuTunggu = parseInt(document.getElementById('waktuTungguBk').value);
            const pasanganInput = document.getElementById('pasanganBk').value;
            const pasanganArray = pasanganInput.split(',').map(p => parseInt(p.trim())).filter(p => !isNaN(p) && p > 0);
            
            if (pasanganArray.length === 0) {
                showStatusBk('Masukkan minimal 1 pasangan yang valid!', 'error');
                return;
            }

            // Convert array to object
            const pasanganObj = {};
            pasanganArray.forEach((p, index) => {
                pasanganObj[index] = p;
            });

            try {
                // Save settings
                await database.ref('tebak-angka/aturan').set({
                    mode: currentModeBk,
                    waktu_tunggu: waktuTunggu,
                    aktif: true,
                    last_updated: new Date().toISOString(),
                    last_updated_by: 'admin',
                    game_type: 'besar_kecil'
                });

                await database.ref('tebak-angka/pasangan').set(pasanganObj);

                // Show success message
                showStatusBk('‚úÖ Pengaturan Besar/Kecil berhasil disimpan!', 'success');
                
                // Update display
                document.getElementById('current-mode-bk').textContent = currentModeBk.toUpperCase();
                document.getElementById('current-timer-bk').textContent = waktuTunggu + ' detik';

                // Start game engine if not already running
                if (!currentGameIntervalBk) {
                    startGameEngineBk();
                }

            } catch (error) {
                showStatusBk('‚ùå Error: ' + error.message, 'error');
            }
        }

        function startGameEngineBk() {
            console.log("üöÄ Game engine Besar/Kecil dimulai...");
            
            // Hentikan interval sebelumnya jika ada
            if (currentGameIntervalBk) {
                clearInterval(currentGameIntervalBk);
            }
            
            // Update engine status
            document.getElementById('engine-status-bk').textContent = 'AKTIF';
            document.getElementById('engine-status-bk').style.color = '#28a745';
            
            // Mulai interval untuk memeriksa round
            currentGameIntervalBk = setInterval(() => {
                checkAndProcessRoundsBk();
            }, 1000);
            
            showStatusBk('‚úÖ Game engine Besar/Kecil berhasil dimulai!', 'success');
        }

        async function checkAndProcessRoundsBk() {
            try {
                const snapshot = await database.ref('tebak-angka/taruhan').once('value');
                if (!snapshot.exists()) return;
                
                const rounds = snapshot.val();
                const now = Date.now();
                
                for (const roundId in rounds) {
                    const round = rounds[roundId];
                    
                    // Hanya proses round dengan game_type 'besar_kecil' atau tanpa game_type (legacy)
                    const gameType = round.game_type || 'besar_kecil';
                    if (gameType !== 'besar_kecil') continue;
                    
                    // Cek round yang sedang berjalan dan sudah habis waktunya
                    if (round.status === 'berjalan' && round.end_time && round.end_time <= now) {
                        console.log(`‚è∞ Round ${roundId} waktu habis, menentukan hasil...`);
                        await processRoundResultBk(roundId, round);
                    }
                }
            } catch (error) {
                console.error("Error checking BK rounds:", error);
            }
        }

        async function processRoundResultBk(roundId, roundData) {
            try {
                // Tentukan hasil
                let hasilBesarKecil;
                
                // Gunakan pilihan admin jika ada, atau generate berdasarkan mode
                if (selectedHasilBesarKecil) {
                    hasilBesarKecil = selectedHasilBesarKecil;
                    console.log(`üéØ Menggunakan hasil admin: ${hasilBesarKecil}`);
                } else if (currentModeBk === 'harus_besar') {
                    hasilBesarKecil = 'BESAR';
                    console.log(`üé∞ Mode 'harus_besar': ${hasilBesarKecil}`);
                } else if (currentModeBk === 'harus_kecil') {
                    hasilBesarKecil = 'KECIL';
                    console.log(`üé∞ Mode 'harus_kecil': ${hasilBesarKecil}`);
                } else {
                    // Random: 50% besar, 50% kecil
                    hasilBesarKecil = Math.random() > 0.5 ? 'BESAR' : 'KECIL';
                    console.log(`üé≤ Hasil random: ${hasilBesarKecil}`);
                }
                
                console.log(`üîÑ Memproses round ${roundId}: ${hasilBesarKecil}`);
                
                // Generate angka random berdasarkan hasil
                let angkaHasil;
                if (hasilBesarKecil === 'BESAR') {
                    angkaHasil = Math.floor(Math.random() * 5) + 5; // 5-9
                } else {
                    angkaHasil = Math.floor(Math.random() * 5); // 0-4
                }
                
                // Simpan hasil ke Firebase
                await database.ref(`tebak-angka/taruhan/${roundId}`).update({
                    status: 'selesai',
                    hasil: hasilBesarKecil,
                    angka_hasil: angkaHasil,
                    waktu_hasil: Date.now(),
                    mode_terpakai: currentModeBk
                });
                
                // PROSES KEMENANGAN SETIAP USER
                await processUserResultsBk(roundId, roundData, hasilBesarKecil);
                
                // Simpan ke history hasil
                await saveToResultHistoryBk(roundId, hasilBesarKecil, angkaHasil);
                
                // Reset pilihan admin untuk round berikutnya
                selectedHasilBesarKecil = null;
                updateHasilButtonsBk();
                
                showStatusBk(`‚úÖ Hasil ditentukan: ${hasilBesarKecil} (Angka: ${angkaHasil}) untuk round ${roundId}`, 'success');
                
            } catch (error) {
                console.error("‚ùå Error memproses hasil round BK:", error);
                showStatusBk(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function processUserResultsBk(roundId, roundData, hasilBesarKecil) {
            try {
                const taruhanUsers = roundData.taruhan_users;
                if (!taruhanUsers) {
                    console.log(`üì≠ Tidak ada user untuk round ${roundId}`);
                    return;
                }
                
                const userCount = Object.keys(taruhanUsers).length;
                console.log(`üìä Memproses ${userCount} user untuk round ${roundId}`);
                
                // Array untuk menyimpan semua promise update saldo
                const updatePromises = [];
                
                for (const userId in taruhanUsers) {
                    const taruhan = taruhanUsers[userId];
                    
                    // Cek hasil besar/kecil
                    let menangBesarKecil = false;
                    if (taruhan.pilihan) {
                        menangBesarKecil = taruhan.pilihan === hasilBesarKecil;
                    }
                    
                    const pasangan = Number(taruhan.pasangan) || 0;
                    let totalKemenangan = 0;
                    
                    if (taruhan.pilihan) {
                        if (menangBesarKecil) {
                            // MENANG: Dapat 2x pasangan (kembali pasangan + kemenangan 1:1)
                            totalKemenangan = 2 * pasangan;
                        } else {
                            // KALAH: Tidak dapat apa-apa (saldo sudah dipotong di frontend)
                            totalKemenangan = 0;
                        }
                    }
                    
                    const saldoNetto = totalKemenangan;
                    const menangOverall = saldoNetto > 0;
                    
                    console.log(`  üë§ User ${userId.substring(0, 8)}...: 
                        Pilihan=${taruhan.pilihan || '-'}, 
                        Pasangan=${pasangan}, 
                        Menang=${menangBesarKecil}, 
                        Kemenangan=${totalKemenangan},
                        Netto=${saldoNetto}`);
                    
                    // Simpan promise update saldo ke array
                    updatePromises.push(
                        updateUserBalance(userId, saldoNetto)
                    );
                    
                    // Update status taruhan user
                    await database.ref(`tebak-angka/taruhan/${roundId}/taruhan_users/${userId}`).update({
                        status: menangOverall ? 'menang' : 'kalah',
                        hasil: menangOverall ? 'MENANG' : 'KALAH',
                        hasil_besar_kecil: taruhan.pilihan ? (menangBesarKecil ? 'MENANG' : 'KALAH') : 'TIDAK_TARUH',
                        waktu_hasil: Date.now(),
                        kemenangan: totalKemenangan,
                        saldo_netto: saldoNetto
                    });
                    
                    // Simpan ke history user
                    await saveToUserHistory(userId, {
                        round_id: roundId,
                        pilihan: taruhan.pilihan,
                        pasangan: pasangan,
                        hasil: menangOverall ? 'MENANG' : 'KALAH',
                        hasil_besar_kecil: taruhan.pilihan ? (menangBesarKecil ? 'MENANG' : 'KALAH') : 'TIDAK_TARUH',
                        kemenangan: totalKemenangan,
                        saldo_netto: saldoNetto,
                        waktu: Date.now()
                    });
                }
                
                // Tunggu semua update saldo selesai
                await Promise.all(updatePromises);
                
                console.log(`‚úÖ Berhasil memproses ${userCount} user untuk round ${roundId}`);
                
            } catch (error) {
                console.error(`‚ùå Error memproses hasil user untuk round ${roundId}:`, error);
                throw error;
            }
        }

        async function updateUserBalance(userId, saldoNetto) {
            try {
                console.log(`üîÑ MENGUPDATE SALDO USER: ${userId.substring(0, 8)}..., perubahan: ${saldoNetto}`);
                
                if (!userId) {
                    console.error('‚ùå User ID tidak valid');
                    return;
                }
                
                // Jika saldoNetto = 0 (kalah), tidak perlu update
                if (saldoNetto === 0) {
                    console.log(`  ‚Üí User kalah, tidak ada perubahan saldo (uang taruhan sudah dipotong di frontend)`);
                    return;
                }
                
                // Hanya update jika ada kemenangan
                const saldoRef = database.ref(`tebak-angka/saldo/${userId}`);
                
                await saldoRef.transaction((currentBalance) => {
                    console.log(`üìä Transaction dimulai untuk user ${userId.substring(0, 8)}...`);
                    
                    if (currentBalance === null || currentBalance === undefined) {
                        console.log(`  ‚Üí User belum punya saldo, set ke 50000`);
                        return 50000 + (saldoNetto || 0);
                    }
                    
                    const current = Number(currentBalance);
                    const change = Number(saldoNetto);
                    
                    if (isNaN(current) || isNaN(change)) {
                        console.error('‚ùå Data saldo tidak valid:', { current, change });
                        return current;
                    }
                    
                    let newBalance = current + change;
                    
                    console.log(`  ‚Üí Perhitungan: ${current} ${change >= 0 ? '+' : ''}${change} = ${newBalance}`);
                    
                    return newBalance;
                });
                
            } catch (error) {
                console.error(`‚ùå Error mengupdate saldo user ${userId}:`, error);
                throw error;
            }
        }

        async function saveToResultHistoryBk(roundId, hasilBesarKecil, angkaHasil) {
            try {
                await database.ref(`tebak-angka/hasil_round/${roundId}`).set({
                    hasil: hasilBesarKecil,
                    angka_hasil: angkaHasil,
                    timestamp: Date.now(),
                    round_id: roundId,
                    mode: currentModeBk,
                    game_type: 'besar_kecil'
                });
            } catch (error) {
                console.error("Error menyimpan ke history hasil BK:", error);
            }
        }

        async function saveToUserHistory(userId, data) {
            try {
                await database.ref(`tebak-angka/history/${userId}/${Date.now()}`).set(data);
            } catch (error) {
                console.error("Error menyimpan history user:", error);
            }
        }

        async function startNewRoundBk() {
            try {
                const roundId = generateRoundId(); // Contoh: 20260120100052119
                const waktuTunggu = parseInt(document.getElementById('waktuTungguBk').value) || 15;
                const endTime = Date.now() + (waktuTunggu * 1000);
                
                await database.ref(`tebak-angka/taruhan/${roundId}`).set({
                    round_id: roundId,
                    status: 'berjalan',
                    hasil: null,
                    angka_hasil: null,
                    start_time: Date.now(),
                    end_time: endTime,
                    waktu_tunggu: waktuTunggu,
                    created_at: Date.now(),
                    mode: currentModeBk,
                    game_type: 'besar_kecil'
                });
                
                console.log(`üöÄ Round BK baru dibuat: ${roundId}`);
                showStatusBk(`‚úÖ Round BK baru dimulai: ${roundId}`, 'success');
                
                return roundId;
            } catch (error) {
                console.error("Error membuat round BK baru:", error);
                showStatusBk(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function forceRoundResultBk() {
            if (!activeRoundIdBk) {
                showStatusBk('‚ùå Tidak ada round BK aktif!', 'error');
                return;
            }
            
            if (confirm('Yakin menentukan hasil untuk round BK ini sekarang?')) {
                try {
                    const snapshot = await database.ref(`tebak-angka/taruhan/${activeRoundIdBk}`).once('value');
                    if (!snapshot.exists()) {
                        showStatusBk('‚ùå Round BK tidak ditemukan!', 'error');
                        return;
                    }
                    
                    const roundData = snapshot.val();
                    
                    // Tentukan hasil
                    let hasilBesarKecil;
                    
                    // Gunakan pilihan admin jika ada
                    if (selectedHasilBesarKecil) {
                        hasilBesarKecil = selectedHasilBesarKecil;
                    } else if (currentModeBk === 'harus_besar') {
                        hasilBesarKecil = 'BESAR';
                    } else if (currentModeBk === 'harus_kecil') {
                        hasilBesarKecil = 'KECIL';
                    } else {
                        hasilBesarKecil = Math.random() > 0.5 ? 'BESAR' : 'KECIL';
                    }
                    
                    // Generate angka random berdasarkan hasil
                    let angkaHasil;
                    if (hasilBesarKecil === 'BESAR') {
                        angkaHasil = Math.floor(Math.random() * 5) + 5; // 5-9
                    } else {
                        angkaHasil = Math.floor(Math.random() * 5); // 0-4
                    }
                    
                    // Update round dengan hasil
                    await database.ref(`tebak-angka/taruhan/${activeRoundIdBk}`).update({
                        status: 'selesai',
                        hasil: hasilBesarKecil,
                        angka_hasil: angkaHasil,
                        end_time: Date.now(),
                        waktu_hasil: Date.now(),
                        mode_terpakai: currentModeBk
                    });
                    
                    // Proses hasil
                    await processUserResultsBk(activeRoundIdBk, roundData, hasilBesarKecil);
                    await saveToResultHistoryBk(activeRoundIdBk, hasilBesarKecil, angkaHasil);
                    
                    // Reset pilihan admin
                    selectedHasilBesarKecil = null;
                    updateHasilButtonsBk();
                    
                    showStatusBk(`‚úÖ Hasil BK dipaksakan: ${hasilBesarKecil} (Angka: ${angkaHasil}) untuk round ${activeRoundIdBk}`, 'success');
                    
                } catch (error) {
                    console.error("Error memaksa hasil round BK:", error);
                    showStatusBk(`‚ùå Error: ${error.message}`, 'error');
                }
            }
        }

        async function forceResetGameBk() {
            if (confirm('Apakah Anda yakin ingin mereset permainan Besar/Kecil? Ini akan menghentikan semua ronde yang sedang berjalan.')) {
                try {
                    // Hentikan game engine
                    if (currentGameIntervalBk) {
                        clearInterval(currentGameIntervalBk);
                        currentGameIntervalBk = null;
                        document.getElementById('engine-status-bk').textContent = 'NONAKTIF';
                        document.getElementById('engine-status-bk').style.color = '#dc3545';
                    }
                    
                    // Reset semua data di Firebase (hanya yang game_type = 'besar_kecil' atau tanpa game_type)
                    const snapshot = await database.ref('tebak-angka/taruhan').once('value');
                    if (snapshot.exists()) {
                        const rounds = snapshot.val();
                        const updates = {};
                        
                        for (const roundId in rounds) {
                            const round = rounds[roundId];
                            const gameType = round.game_type || 'besar_kecil';
                            if (gameType === 'besar_kecil') {
                                updates[roundId] = null;
                            }
                        }
                        
                        await database.ref('tebak-angka/taruhan').update(updates);
                    }
                    
                    // Reset hasil round history
                    const historySnapshot = await database.ref('tebak-angka/hasil_round').once('value');
                    if (historySnapshot.exists()) {
                        const history = historySnapshot.val();
                        const updates = {};
                        
                        for (const roundId in history) {
                            const item = history[roundId];
                            if (item.game_type === 'besar_kecil' || !item.game_type) {
                                updates[roundId] = null;
                            }
                        }
                        
                        await database.ref('tebak-angka/hasil_round').update(updates);
                    }
                    
                    showStatusBk('‚úÖ Permainan Besar/Kecil telah direset!', 'success');
                    
                    // Reset UI
                    resetDisplayBk();
                    
                } catch (error) {
                    showStatusBk('‚ùå Error resetting game BK: ' + error.message, 'error');
                }
            }
        }

        function showStatusBk(message, type) {
            const statusDiv = document.getElementById('status-bk');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = 'status';
            }, 5000);
        }

        function resetDisplayBk() {
            document.getElementById('current-round-id-bk').textContent = '-';
            document.getElementById('current-round-status-bk').textContent = 'Tidak ada round aktif';
            document.getElementById('current-round-timer-bk').textContent = '-';
            document.getElementById('current-round-mode-bk').textContent = '-';
            resetBetMonitoringBk();
        }

        function resetBetMonitoringBk() {
            document.getElementById('besar-count').textContent = '0';
            document.getElementById('besar-total').textContent = '0';
            document.getElementById('besar-max').textContent = '-';
            document.getElementById('besar-max-user').textContent = '-';
            
            document.getElementById('kecil-count').textContent = '0';
            document.getElementById('kecil-total').textContent = '0';
            document.getElementById('kecil-max').textContent = '-';
            document.getElementById('kecil-max-user').textContent = '-';
            
            document.getElementById('bet-details-bk').innerHTML = '<div class="no-data">Belum ada taruhan</div>';
        }

        // ==================== FUNGSI UNTUK GAME TEBAK ANGKA ====================

        function setModeAngka(mode) {
            currentModeAngka = mode;
            updateModeButtonsAngka();
        }

        function updateModeButtonsAngka() {
            // Reset semua button angka
            document.querySelectorAll('.mode-btn.angka-mode').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = '#0066cc';
            });
            
            // Aktifkan button yang sesuai
            let btnId = '';
            if (currentModeAngka === 'random_angka') btnId = 'btn-random-angka';
            else if (currentModeAngka === 'harus_besar') btnId = 'btn-besar-angka';
            else if (currentModeAngka === 'harus_kecil') btnId = 'btn-kecil-angka';
            
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.classList.add('active');
                btn.style.background = '#0066cc';
                btn.style.color = 'white';
            }
        }

        function setHasilAngka(angka) {
            selectedHasilAngka = angka;
            updateHasilButtonsAngka();
            updateSelectedHasilAngkaText();
        }

        function updateHasilButtonsAngka() {
            // Reset semua button hasil angka
            document.querySelectorAll('.hasil-btn').forEach(btn => {
                if (btn.id.startsWith('btn-hasil-') && !isNaN(parseInt(btn.id.split('-')[2]))) {
                    btn.classList.remove('active');
                    btn.style.background = 'white';
                    btn.style.color = '#0066cc';
                }
            });
            
            // Aktifkan button yang sesuai
            if (selectedHasilAngka !== null) {
                const btn = document.getElementById(`btn-hasil-${selectedHasilAngka}`);
                if (btn) {
                    btn.classList.add('active');
                    btn.style.background = '#0066cc';
                    btn.style.color = 'white';
                }
            }
        }

        function updateSelectedHasilAngkaText() {
            if (selectedHasilAngka !== null) {
                const angka = selectedHasilAngka;
                const kategori = angka >= 5 ? 'BESAR' : 'KECIL';
                const warna = angka >= 5 ? '#d70000' : '#0066cc';
                const emoji = angka >= 5 ? 'üî¥' : 'üîµ';
                
                document.getElementById('selected-hasil-angka-text').textContent = angka;
                document.getElementById('selected-hasil-kategori').innerHTML = 
                    `<span style="color:${warna}">${emoji} ${kategori}</span>`;
            } else {
                document.getElementById('selected-hasil-angka-text').textContent = '-';
                document.getElementById('selected-hasil-kategori').textContent = '';
            }
        }

        async function loadAngkaSettings() {
            try {
                const snapshot = await database.ref('tebak-angka/aturan_angka').once('value');
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    currentModeAngka = data.mode || 'random_angka';
                    updateModeButtonsAngka();
                    document.getElementById('waktuTungguAngka').value = data.waktu_tunggu || 15;
                    
                    let modeText = 'RANDOM ANGKA';
                    if (currentModeAngka === 'harus_besar') modeText = 'HARUS BESAR (5-9)';
                    else if (currentModeAngka === 'harus_kecil') modeText = 'HARUS KECIL (0-4)';
                    
                    document.getElementById('current-mode-angka').textContent = modeText;
                    document.getElementById('current-timer-angka').textContent = (data.waktu_tunggu || 15) + ' detik';
                    
                    // Auto-start game engine jika belum berjalan
                    if (data.aktif && !currentGameIntervalAngka) {
                        startGameEngineAngka();
                    }
                }
            } catch (error) {
                console.error("Error loading Angka settings:", error);
            }
        }

        async function saveSettingsAngka() {
            const waktuTunggu = parseInt(document.getElementById('waktuTungguAngka').value);
            const pasanganInput = document.getElementById('pasanganAngka').value;
            const pasanganArray = pasanganInput.split(',').map(p => parseInt(p.trim())).filter(p => !isNaN(p) && p > 0);
            
            if (pasanganArray.length === 0) {
                showStatusAngka('Masukkan minimal 1 pasangan yang valid!', 'error');
                return;
            }

            // Convert array to object
            const pasanganObj = {};
            pasanganArray.forEach((p, index) => {
                pasanganObj[index] = p;
            });

            try {
                // Save settings untuk game angka
                await database.ref('tebak-angka/aturan_angka').set({
                    mode: currentModeAngka,
                    waktu_tunggu: waktuTunggu,
                    aktif: true,
                    last_updated: new Date().toISOString(),
                    last_updated_by: 'admin',
                    game_type: 'tebak_angka'
                });

                await database.ref('tebak-angka/pasangan_angka').set(pasanganObj);

                // Show success message
                showStatusAngka('‚úÖ Pengaturan Tebak Angka berhasil disimpan!', 'success');
                
                // Update display
                let modeText = 'RANDOM ANGKA';
                if (currentModeAngka === 'harus_besar') modeText = 'HARUS BESAR (5-9)';
                else if (currentModeAngka === 'harus_kecil') modeText = 'HARUS KECIL (0-4)';
                
                document.getElementById('current-mode-angka').textContent = modeText;
                document.getElementById('current-timer-angka').textContent = waktuTunggu + ' detik';

                // Start game engine if not already running
                if (!currentGameIntervalAngka) {
                    startGameEngineAngka();
                }

            } catch (error) {
                showStatusAngka('‚ùå Error: ' + error.message, 'error');
            }
        }

        function startGameEngineAngka() {
            console.log("üöÄ Game engine Tebak Angka dimulai...");
            
            // Hentikan interval sebelumnya jika ada
            if (currentGameIntervalAngka) {
                clearInterval(currentGameIntervalAngka);
            }
            
            // Update engine status
            document.getElementById('engine-status-angka').textContent = 'AKTIF';
            document.getElementById('engine-status-angka').style.color = '#28a745';
            
            // Mulai interval untuk memeriksa round
            currentGameIntervalAngka = setInterval(() => {
                checkAndProcessRoundsAngka();
            }, 1000);
            
            showStatusAngka('‚úÖ Game engine Tebak Angka berhasil dimulai!', 'success');
        }

        async function checkAndProcessRoundsAngka() {
            try {
                const snapshot = await database.ref('tebak-angka/taruhan_angka').once('value');
                if (!snapshot.exists()) return;
                
                const rounds = snapshot.val();
                const now = Date.now();
                
                for (const roundId in rounds) {
                    const round = rounds[roundId];
                    
                    // Hanya proses round dengan game_type 'tebak_angka'
                    const gameType = round.game_type || 'tebak_angka';
                    if (gameType !== 'tebak_angka') continue;
                    
                    // Cek round yang sedang berjalan dan sudah habis waktunya
                    if (round.status === 'berjalan' && round.end_time && round.end_time <= now) {
                        console.log(`‚è∞ Round Angka ${roundId} waktu habis, menentukan hasil...`);
                        await processRoundResultAngka(roundId, round);
                    }
                }
            } catch (error) {
                console.error("Error checking Angka rounds:", error);
            }
        }

        async function processRoundResultAngka(roundId, roundData) {
            try {
                // Tentukan hasil angka
                let angkaHasil;
                
                // Gunakan pilihan admin jika ada, atau generate berdasarkan mode
                if (selectedHasilAngka !== null) {
                    angkaHasil = selectedHasilAngka;
                    console.log(`üéØ Menggunakan hasil admin: Angka ${angkaHasil}`);
                } else if (currentModeAngka === 'harus_besar') {
                    // Random angka 5-9
                    angkaHasil = Math.floor(Math.random() * 5) + 5;
                    console.log(`üé∞ Mode 'harus_besar': Angka ${angkaHasil}`);
                } else if (currentModeAngka === 'harus_kecil') {
                    // Random angka 0-4
                    angkaHasil = Math.floor(Math.random() * 5);
                    console.log(`üé∞ Mode 'harus_kecil': Angka ${angkaHasil}`);
                } else {
                    // Random: angka 0-9
                    angkaHasil = Math.floor(Math.random() * 10);
                    console.log(`üé≤ Hasil random: Angka ${angkaHasil}`);
                }
                
                // Tentukan kategori berdasarkan angka
                const kategoriHasil = angkaHasil >= 5 ? 'BESAR' : 'KECIL';
                
                console.log(`üîÑ Memproses round angka ${roundId}: Angka ${angkaHasil} (${kategoriHasil})`);
                
                // Simpan hasil ke Firebase
                await database.ref(`tebak-angka/taruhan_angka/${roundId}`).update({
                    status: 'selesai',
                    hasil: angkaHasil.toString(),
                    kategori_hasil: kategoriHasil,
                    waktu_hasil: Date.now(),
                    mode_terpakai: currentModeAngka
                });
                
                // PROSES KEMENANGAN SETIAP USER
                await processUserResultsAngka(roundId, roundData, angkaHasil);
                
                // Simpan ke history hasil
                await saveToResultHistoryAngka(roundId, angkaHasil, kategoriHasil);
                
                // Reset pilihan admin untuk round berikutnya
                selectedHasilAngka = null;
                updateHasilButtonsAngka();
                updateSelectedHasilAngkaText();
                
                showStatusAngka(`‚úÖ Hasil ditentukan: Angka ${angkaHasil} (${kategoriHasil}) untuk round ${roundId}`, 'success');
                
            } catch (error) {
                console.error("‚ùå Error memproses hasil round Angka:", error);
                showStatusAngka(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function processUserResultsAngka(roundId, roundData, angkaHasil) {
            try {
                const taruhanUsers = roundData.taruhan_users;
                if (!taruhanUsers) {
                    console.log(`üì≠ Tidak ada user untuk round angka ${roundId}`);
                    return;
                }
                
                const userCount = Object.keys(taruhanUsers).length;
                console.log(`üìä Memproses ${userCount} user untuk round angka ${roundId}`);
                
                // Tentukan kategori berdasarkan angka hasil
                const kategoriHasil = angkaHasil >= 5 ? 'BESAR' : 'KECIL';
                
                // Array untuk menyimpan semua promise update saldo
                const updatePromises = [];
                
                for (const userId in taruhanUsers) {
                    const taruhan = taruhanUsers[userId];
                    
                    // Cek hasil angka
                    const angkaTebakan = parseInt(taruhan.angka_tebakan);
                    const menang = angkaTebakan === angkaHasil;
                    
                    const pasangan = Number(taruhan.pasangan) || 0;
                    let totalKemenangan = 0;
                    
                    if (menang) {
                        // MENANG: Dapat 2x pasangan (kembali pasangan + kemenangan 1:1)
                        totalKemenangan = 2 * pasangan;
                    } else {
                        // KALAH: Tidak dapat apa-apa (saldo sudah dipotong di frontend)
                        totalKemenangan = 0;
                    }
                    
                    const saldoNetto = totalKemenangan;
                    const menangOverall = saldoNetto > 0;
                    
                    console.log(`  üë§ User ${userId.substring(0, 8)}...: 
                        Angka Tebakan=${angkaTebakan}, 
                        Pasangan=${pasangan}, 
                        Menang=${menang}, 
                        Kemenangan=${totalKemenangan},
                        Netto=${saldoNetto}`);
                    
                    // Simpan promise update saldo ke array
                    updatePromises.push(
                        updateUserBalance(userId, saldoNetto)
                    );
                    
                    // Update status taruhan user
                    await database.ref(`tebak-angka/taruhan_angka/${roundId}/taruhan_users/${userId}`).update({
                        status: menangOverall ? 'menang' : 'kalah',
                        hasil: menangOverall ? 'MENANG' : 'KALAH',
                        hasil_angka: menang ? 'MENANG' : 'KALAH',
                        waktu_hasil: Date.now(),
                        kemenangan: totalKemenangan,
                        saldo_netto: saldoNetto
                    });
                    
                    // Simpan ke history user
                    await saveToUserHistoryAngka(userId, {
                        round_id: roundId,
                        angka_tebakan: angkaTebakan,
                        pasangan: pasangan,
                        hasil: menangOverall ? 'MENANG' : 'KALAH',
                        hasil_angka: menang ? 'MENANG' : 'KALAH',
                        kemenangan: totalKemenangan,
                        saldo_netto: saldoNetto,
                        waktu: Date.now()
                    });
                }
                
                // Tunggu semua update saldo selesai
                await Promise.all(updatePromises);
                
                console.log(`‚úÖ Berhasil memproses ${userCount} user untuk round angka ${roundId}`);
                
            } catch (error) {
                console.error(`‚ùå Error memproses hasil user untuk round angka ${roundId}:`, error);
                throw error;
            }
        }

        async function saveToResultHistoryAngka(roundId, angkaHasil, kategoriHasil) {
            try {
                await database.ref(`tebak-angka/hasil_round_angka/${roundId}`).set({
                    hasil: angkaHasil.toString(),
                    kategori: kategoriHasil,
                    timestamp: Date.now(),
                    round_id: roundId,
                    mode: currentModeAngka,
                    game_type: 'tebak_angka'
                });
            } catch (error) {
                console.error("Error menyimpan ke history hasil Angka:", error);
            }
        }

        async function saveToUserHistoryAngka(userId, data) {
            try {
                await database.ref(`tebak-angka/history_angka/${userId}/${Date.now()}`).set(data);
            } catch (error) {
                console.error("Error menyimpan history user angka:", error);
            }
        }

        async function startNewRoundAngka() {
            try {
                const roundId = generateRoundId(); // Contoh: 20260120100052118
                const waktuTunggu = parseInt(document.getElementById('waktuTungguAngka').value) || 15;
                const endTime = Date.now() + (waktuTunggu * 1000);
                
                await database.ref(`tebak-angka/taruhan_angka/${roundId}`).set({
                    round_id: roundId,
                    status: 'berjalan',
                    hasil: null,
                    kategori_hasil: null,
                    start_time: Date.now(),
                    end_time: endTime,
                    waktu_tunggu: waktuTunggu,
                    created_at: Date.now(),
                    mode: currentModeAngka,
                    game_type: 'tebak_angka'
                });
                
                console.log(`üöÄ Round Angka baru dibuat: ${roundId}`);
                showStatusAngka(`‚úÖ Round Angka baru dimulai: ${roundId}`, 'success');
                
                return roundId;
            } catch (error) {
                console.error("Error membuat round Angka baru:", error);
                showStatusAngka(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function forceRoundResultAngka() {
            if (!activeRoundIdAngka) {
                showStatusAngka('‚ùå Tidak ada round Angka aktif!', 'error');
                return;
            }
            
            if (confirm('Yakin menentukan hasil untuk round Angka ini sekarang?')) {
                try {
                    const snapshot = await database.ref(`tebak-angka/taruhan_angka/${activeRoundIdAngka}`).once('value');
                    if (!snapshot.exists()) {
                        showStatusAngka('‚ùå Round Angka tidak ditemukan!', 'error');
                        return;
                    }
                    
                    const roundData = snapshot.val();
                    
                    // Tentukan hasil angka
                    let angkaHasil;
                    
                    // Gunakan pilihan admin jika ada
                    if (selectedHasilAngka !== null) {
                        angkaHasil = selectedHasilAngka;
                    } else if (currentModeAngka === 'harus_besar') {
                        // Random angka 5-9
                        angkaHasil = Math.floor(Math.random() * 5) + 5;
                    } else if (currentModeAngka === 'harus_kecil') {
                        // Random angka 0-4
                        angkaHasil = Math.floor(Math.random() * 5);
                    } else {
                        // Random: angka 0-9
                        angkaHasil = Math.floor(Math.random() * 10);
                    }
                    
                    // Tentukan kategori berdasarkan angka
                    const kategoriHasil = angkaHasil >= 5 ? 'BESAR' : 'KECIL';
                    
                    // Update round dengan hasil
                    await database.ref(`tebak-angka/taruhan_angka/${activeRoundIdAngka}`).update({
                        status: 'selesai',
                        hasil: angkaHasil.toString(),
                        kategori_hasil: kategoriHasil,
                        end_time: Date.now(),
                        waktu_hasil: Date.now(),
                        mode_terpakai: currentModeAngka
                    });
                    
                    // Proses hasil
                    await processUserResultsAngka(activeRoundIdAngka, roundData, angkaHasil);
                    await saveToResultHistoryAngka(activeRoundIdAngka, angkaHasil, kategoriHasil);
                    
                    // Reset pilihan admin
                    selectedHasilAngka = null;
                    updateHasilButtonsAngka();
                    updateSelectedHasilAngkaText();
                    
                    showStatusAngka(`‚úÖ Hasil Angka dipaksakan: Angka ${angkaHasil} (${kategoriHasil}) untuk round ${activeRoundIdAngka}`, 'success');
                    
                } catch (error) {
                    console.error("Error memaksa hasil round Angka:", error);
                    showStatusAngka(`‚ùå Error: ${error.message}`, 'error');
                }
            }
        }

        async function forceResetGameAngka() {
            if (confirm('Apakah Anda yakin ingin mereset permainan Tebak Angka? Ini akan menghentikan semua ronde yang sedang berjalan.')) {
                try {
                    // Hentikan game engine
                    if (currentGameIntervalAngka) {
                        clearInterval(currentGameIntervalAngka);
                        currentGameIntervalAngka = null;
                        document.getElementById('engine-status-angka').textContent = 'NONAKTIF';
                        document.getElementById('engine-status-angka').style.color = '#dc3545';
                    }
                    
                    // Reset semua data di Firebase untuk game angka
                    await database.ref('tebak-angka/taruhan_angka').remove();
                    await database.ref('tebak-angka/hasil_round_angka').remove();
                    
                    showStatusAngka('‚úÖ Permainan Tebak Angka telah direset!', 'success');
                    
                    // Reset UI
                    resetDisplayAngka();
                    
                } catch (error) {
                    showStatusAngka('‚ùå Error resetting game Angka: ' + error.message, 'error');
                }
            }
        }

        function showStatusAngka(message, type) {
            const statusDiv = document.getElementById('status-angka');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = 'status';
            }, 5000);
        }

        function resetDisplayAngka() {
            document.getElementById('current-round-id-angka').textContent = '-';
            document.getElementById('current-round-status-angka').textContent = 'Tidak ada round aktif';
            document.getElementById('current-round-timer-angka').textContent = '-';
            document.getElementById('current-round-mode-angka').textContent = '-';
            resetBetMonitoringAngka();
        }

        function resetBetMonitoringAngka() {
            const betCardsContainer = document.querySelector('#tab-angka .bet-cards');
            betCardsContainer.innerHTML = '';
            
            // Buat 10 kartu untuk angka 0-9
            for (let i = 0; i < 10; i++) {
                const betCard = document.createElement('div');
                betCard.className = `bet-card angka-${i}`;
                betCard.id = `bet-card-${i}`;
                betCard.innerHTML = `
                    <div class="bet-title angka-${i}">${i}</div>
                    <div class="bet-info">
                        <div class="bet-info-item">
                            <div class="bet-number" id="angka-${i}-count">0</div>
                            <div class="bet-label">Jumlah User</div>
                        </div>
                        <div class="bet-info-item">
                            <div class="bet-number" id="angka-${i}-total">0</div>
                            <div class="bet-label">Total Pasangan</div>
                        </div>
                    </div>
                    <div class="max-bet">
                        <div class="bet-label">Taruhan Terbesar</div>
                        <div class="max-bet-value" id="angka-${i}-max">-</div>
                        <div class="max-bet-user" id="angka-${i}-max-user">-</div>
                    </div>
                `;
                betCardsContainer.appendChild(betCard);
            }
            
            document.getElementById('bet-details-angka').innerHTML = '<div class="no-data">Belum ada taruhan</div>';
        }

        // ==================== MONITORING REAL-TIME ====================

        // Monitor current round bets untuk Besar/Kecil
        database.ref('tebak-angka/taruhan').orderByChild('status').equalTo('berjalan').on('value', (snapshot) => {
            if (!snapshot.exists()) {
                resetDisplayBk();
                return;
            }

            const taruhanData = snapshot.val();
            let activeRound = null;
            let activeRoundKey = null;
            let activeRoundCount = 0;

            // Cari round dengan status "berjalan" yang masih valid
            const now = Date.now();
            
            for (const key in taruhanData) {
                const round = taruhanData[key];
                if (!round) continue;
                
                // Hanya tampilkan round dengan game_type 'besar_kecil' atau tanpa game_type
                const gameType = round.game_type || 'besar_kecil';
                if (gameType !== 'besar_kecil') continue;
                
                if (round.status === 'berjalan') {
                    activeRoundCount++;
                    // Jika round memiliki end_time, cek apakah belum expired
                    if (round.end_time && round.end_time > now) {
                        activeRound = round;
                        activeRoundKey = key;
                    } else if (!round.end_time) {
                        // Jika tidak ada end_time, tetap anggap sebagai round aktif
                        activeRound = round;
                        activeRoundKey = key;
                    }
                }
            }

            // Update active round count
            document.getElementById('active-round-count-bk').textContent = activeRoundCount;

            if (activeRound) {
                activeRoundIdBk = activeRoundKey;
                
                // Update round info
                document.getElementById('current-round-id-bk').textContent = 
                    activeRoundKey ? activeRoundKey : '-';
                document.getElementById('current-round-status-bk').textContent = activeRound.status || '-';
                document.getElementById('current-round-mode-bk').textContent = activeRound.mode || currentModeBk;
                
                // Calculate time remaining
                if (activeRound.end_time) {
                    const timeLeft = Math.max(0, Math.floor((activeRound.end_time - now) / 1000));
                    document.getElementById('current-round-timer-bk').textContent = timeLeft + ' detik';
                    
                    if (timeLeft <= 0) {
                        document.getElementById('current-round-status-bk').textContent = 'WAKTU HABIS';
                        document.getElementById('current-round-timer-bk').style.color = '#ff0000';
                    } else {
                        document.getElementById('current-round-timer-bk').style.color = '#333';
                    }
                } else {
                    document.getElementById('current-round-timer-bk').textContent = '-';
                }

                // Monitor bets in current round
                if (activeRound.taruhan_users && Object.keys(activeRound.taruhan_users).length > 0) {
                    processBetDataBk(activeRound.taruhan_users);
                } else {
                    resetBetMonitoringBk();
                    document.getElementById('bet-details-bk').innerHTML = 
                        '<div class="no-data">Belum ada taruhan di round ini</div>';
                }
            } else {
                resetDisplayBk();
            }
        });

        // Monitor current round bets untuk Tebak Angka
        database.ref('tebak-angka/taruhan_angka').orderByChild('status').equalTo('berjalan').on('value', (snapshot) => {
            if (!snapshot.exists()) {
                resetDisplayAngka();
                return;
            }

            const taruhanData = snapshot.val();
            let activeRound = null;
            let activeRoundKey = null;
            let activeRoundCount = 0;

            // Cari round dengan status "berjalan" yang masih valid
            const now = Date.now();
            
            for (const key in taruhanData) {
                const round = taruhanData[key];
                if (!round) continue;
                
                // Hanya tampilkan round dengan game_type 'tebak_angka'
                const gameType = round.game_type || 'tebak_angka';
                if (gameType !== 'tebak_angka') continue;
                
                if (round.status === 'berjalan') {
                    activeRoundCount++;
                    // Jika round memiliki end_time, cek apakah belum expired
                    if (round.end_time && round.end_time > now) {
                        activeRound = round;
                        activeRoundKey = key;
                    } else if (!round.end_time) {
                        // Jika tidak ada end_time, tetap anggap sebagai round aktif
                        activeRound = round;
                        activeRoundKey = key;
                    }
                }
            }

            // Update active round count
            document.getElementById('active-round-count-angka').textContent = activeRoundCount;

            if (activeRound) {
                activeRoundIdAngka = activeRoundKey;
                
                // Update round info
                document.getElementById('current-round-id-angka').textContent = 
                    activeRoundKey ? activeRoundKey : '-';
                document.getElementById('current-round-status-angka').textContent = activeRound.status || '-';
                document.getElementById('current-round-mode-angka').textContent = activeRound.mode || currentModeAngka;
                
                // Calculate time remaining
                if (activeRound.end_time) {
                    const timeLeft = Math.max(0, Math.floor((activeRound.end_time - now) / 1000));
                    document.getElementById('current-round-timer-angka').textContent = timeLeft + ' detik';
                    
                    if (timeLeft <= 0) {
                        document.getElementById('current-round-status-angka').textContent = 'WAKTU HABIS';
                        document.getElementById('current-round-timer-angka').style.color = '#ff0000';
                    } else {
                        document.getElementById('current-round-timer-angka').style.color = '#333';
                    }
                } else {
                    document.getElementById('current-round-timer-angka').textContent = '-';
                }

                // Monitor bets in current round
                if (activeRound.taruhan_users && Object.keys(activeRound.taruhan_users).length > 0) {
                    processBetDataAngka(activeRound.taruhan_users);
                } else {
                    resetBetMonitoringAngka();
                    document.getElementById('bet-details-angka').innerHTML = 
                        '<div class="no-data">Belum ada taruhan di round ini</div>';
                }
            } else {
                resetDisplayAngka();
            }
        });

        function processBetDataBk(taruhanUsers) {
            let besarCount = 0;
            let besarTotal = 0;
            let besarMax = 0;
            let besarMaxUser = '';
            
            let kecilCount = 0;
            let kecilTotal = 0;
            let kecilMax = 0;
            let kecilMaxUser = '';
            
            const betDetails = [];

            // Process each bet
            for (const userId in taruhanUsers) {
                const bet = taruhanUsers[userId];
                if (!bet) continue;
                
                const amount = parseInt(bet.pasangan) || 0;
                const choice = bet.pilihan;
                const userShort = userId ? (userId.substring(0, 8) + '...') : 'unknown';
                
                betDetails.push({
                    user: userShort,
                    pilihan: choice || '-',
                    pasangan: amount,
                    waktu: bet.waktu_taruhan ? new Date(bet.waktu_taruhan).toLocaleTimeString() : '-'
                });

                if (choice === 'BESAR') {
                    besarCount++;
                    besarTotal += amount;
                    if (amount > besarMax) {
                        besarMax = amount;
                        besarMaxUser = userShort;
                    }
                }
                
                if (choice === 'KECIL') {
                    kecilCount++;
                    kecilTotal += amount;
                    if (amount > kecilMax) {
                        kecilMax = amount;
                        kecilMaxUser = userShort;
                    }
                }
            }

            // Update besar stats
            document.getElementById('besar-count').textContent = besarCount;
            document.getElementById('besar-total').textContent = formatRupiah(besarTotal);
            document.getElementById('besar-max').textContent = formatRupiah(besarMax);
            document.getElementById('besar-max-user').textContent = besarMaxUser || '-';

            // Update kecil stats
            document.getElementById('kecil-count').textContent = kecilCount;
            document.getElementById('kecil-total').textContent = formatRupiah(kecilTotal);
            document.getElementById('kecil-max').textContent = formatRupiah(kecilMax);
            document.getElementById('kecil-max-user').textContent = kecilMaxUser || '-';

            // Update bet details table
            updateBetDetailsTableBk(betDetails);
        }

        function processBetDataAngka(taruhanUsers) {
            // Reset semua angka terlebih dahulu
            for (let i = 0; i < 10; i++) {
                document.getElementById(`angka-${i}-count`).textContent = '0';
                document.getElementById(`angka-${i}-total`).textContent = '0';
                document.getElementById(`angka-${i}-max`).textContent = '-';
                document.getElementById(`angka-${i}-max-user`).textContent = '-';
            }
            
            const betDetails = [];

            // Process each bet
            for (const userId in taruhanUsers) {
                const bet = taruhanUsers[userId];
                if (!bet) continue;
                
                const amount = parseInt(bet.pasangan) || 0;
                const angkaTebakan = parseInt(bet.angka_tebakan);
                const userShort = userId ? (userId.substring(0, 8) + '...') : 'unknown';
                
                if (!isNaN(angkaTebakan) && angkaTebakan >= 0 && angkaTebakan <= 9) {
                    betDetails.push({
                        user: userShort,
                        angka: angkaTebakan,
                        pasangan: amount,
                        waktu: bet.waktu_taruhan ? new Date(bet.waktu_taruhan).toLocaleTimeString() : '-'
                    });

                    // Update stats untuk angka ini
                    const countElement = document.getElementById(`angka-${angkaTebakan}-count`);
                    const totalElement = document.getElementById(`angka-${angkaTebakan}-total`);
                    const maxElement = document.getElementById(`angka-${angkaTebakan}-max`);
                    const maxUserElement = document.getElementById(`angka-${angkaTebakan}-max-user`);
                    
                    // Update count
                    let currentCount = parseInt(countElement.textContent) || 0;
                    countElement.textContent = currentCount + 1;
                    
                    // Update total
                    let currentTotal = parseFloat(totalElement.textContent.replace(/[^0-9]/g, '')) || 0;
                    totalElement.textContent = formatRupiah(currentTotal + amount);
                    
                    // Update max bet
                    let currentMax = parseFloat(maxElement.textContent.replace(/[^0-9]/g, '')) || 0;
                    if (amount > currentMax) {
                        maxElement.textContent = formatRupiah(amount);
                        maxUserElement.textContent = userShort;
                    }
                }
            }

            // Update bet details table
            updateBetDetailsTableAngka(betDetails);
        }

        function updateBetDetailsTableBk(betDetails) {
            const container = document.getElementById('bet-details-bk');
            
            if (betDetails.length === 0) {
                container.innerHTML = '<div class="no-data">Belum ada taruhan</div>';
                return;
            }

            let html = '<table class="history-table" style="margin-top:10px;">';
            html += '<tr><th>User</th><th>Pilihan</th><th>Pasangan</th><th>Waktu</th></tr>';
            
            betDetails.forEach(bet => {
                html += `
                    <tr>
                        <td>${bet.user}</td>
                        <td style="color:${bet.pilihan === 'BESAR' ? '#d70000' : 
                                       bet.pilihan === 'KECIL' ? '#0066cc' : '#666'}; font-weight:bold">
                            ${bet.pilihan}
                        </td>
                        <td>${formatRupiah(bet.pasangan)}</td>
                        <td>${bet.waktu}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            container.innerHTML = html;
        }

        function updateBetDetailsTableAngka(betDetails) {
            const container = document.getElementById('bet-details-angka');
            
            if (betDetails.length === 0) {
                container.innerHTML = '<div class="no-data">Belum ada taruhan</div>';
                return;
            }

            let html = '<table class="history-table" style="margin-top:10px;">';
            html += '<tr><th>User</th><th>Angka</th><th>Pasangan</th><th>Waktu</th></tr>';
            
            betDetails.forEach(bet => {
                // Tentukan warna berdasarkan angka
                let color;
                if (bet.angka === 0) color = '#FF6B6B';
                else if (bet.angka === 1) color = '#4ECDC4';
                else if (bet.angka === 2) color = '#FFD166';
                else if (bet.angka === 3) color = '#06D6A0';
                else if (bet.angka === 4) color = '#118AB2';
                else if (bet.angka === 5) color = '#EF476F';
                else if (bet.angka === 6) color = '#7209B7';
                else if (bet.angka === 7) color = '#F8961E';
                else if (bet.angka === 8) color = '#43AA8B';
                else if (bet.angka === 9) color = '#277DA1';
                else color = '#666';
                
                html += `
                    <tr>
                        <td>${bet.user}</td>
                        <td style="color:${color}; font-weight:bold; font-size: 16px;">
                            ${bet.angka}
                        </td>
                        <td>${formatRupiah(bet.pasangan)}</td>
                        <td>${bet.waktu}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            container.innerHTML = html;
        }

        function formatRupiah(amount) {
            if (!amount || amount === 0) return 'Rp 0';
            return 'Rp ' + amount.toLocaleString('id-ID');
        }

        // Load result history untuk Besar/Kecil
        database.ref('tebak-angka/hasil_round').orderByChild('timestamp').limitToLast(10).on('value', (snapshot) => {
            const container = document.getElementById('result-history-bk');
            if (snapshot.exists()) {
                const resultData = snapshot.val();
                let roundHistory = [];
                
                for (const key in resultData) {
                    const item = resultData[key];
                    // Hanya tampilkan yang game_type 'besar_kecil' atau tanpa game_type
                    if (!item.game_type || item.game_type === 'besar_kecil') {
                        roundHistory.push(item);
                    }
                }
                
                // Sort by timestamp newest first
                roundHistory.sort((a, b) => b.timestamp - a.timestamp);
                
                let html = '';
                roundHistory.forEach(item => {
                    const time = new Date(item.timestamp).toLocaleTimeString();
                    const angkaHasil = item.angka_hasil !== undefined ? ` (Angka: ${item.angka_hasil})` : '';
                    
                    html += `
                        <div class="round-history-item">
                            ${time} - Hasil: <strong>${item.hasil}${angkaHasil}</strong>
                            (Mode: ${item.mode || 'random'})
                        </div>
                    `;
                });
                
                if (html === '') {
                    html = '<div class="no-data">Belum ada hasil round</div>';
                }
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="no-data">Belum ada hasil round</div>';
            }
        });

        // Load result history untuk Tebak Angka
        database.ref('tebak-angka/hasil_round_angka').orderByChild('timestamp').limitToLast(10).on('value', (snapshot) => {
            const container = document.getElementById('result-history-angka');
            if (snapshot.exists()) {
                const resultData = snapshot.val();
                let roundHistory = [];
                
                for (const key in resultData) {
                    const item = resultData[key];
                    // Hanya tampilkan yang game_type 'tebak_angka'
                    if (item.game_type === 'tebak_angka') {
                        roundHistory.push(item);
                    }
                }
                
                // Sort by timestamp newest first
                roundHistory.sort((a, b) => b.timestamp - a.timestamp);
                
                let html = '';
                roundHistory.forEach(item => {
                    const time = new Date(item.timestamp).toLocaleTimeString();
                    const kategori = item.kategori ? ` (${item.kategori})` : '';
                    
                    html += `
                        <div class="round-history-item">
                            ${time} - Hasil: <strong>Angka ${item.hasil}${kategori}</strong>
                            (Mode: ${item.mode || 'random'})
                        </div>
                    `;
                });
                
                if (html === '') {
                    html = '<div class="no-data">Belum ada hasil round</div>';
                }
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="no-data">Belum ada hasil round</div>';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load settings untuk tab aktif pertama (Besar/Kecil)
            loadBkSettings();
            updateModeButtonsBk();
            updateHasilButtonsBk();
            
            // Inisialisasi bet monitoring untuk angka
            resetBetMonitoringAngka();
        });

    </script>
</body>
</html>
