<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tebak Besar Kecil</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #d70000 0%, #8b0000 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 30px;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 4px solid #ffcc00;
            position: relative;
            overflow: visible;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .container.loaded {
            opacity: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffcc00;
        }

        h1 {
            color: #d70000;
            font-size: 26px;
            font-weight: bold;
        }

        .subtitle {
            color: #666;
            font-size: 12px;
            margin-top: 3px;
        }

        /* TIMER CONTAINER BARU - LEBIH SEDERHANA & MOBILE-FRIENDLY */
        .timer-container {
            background: linear-gradient(45deg, #d70000, #8b0000);
            color: white;
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 12px;
            box-shadow: 0 3px 8px rgba(139, 0, 0, 0.35);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }

        .timer-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
        }

        .timer-label {
            font-size: 11px;
            opacity: 0.9;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        #timer {
            font-size: 36px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .timer-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .round-id-label {
            font-size: 9px;
            opacity: 0.8;
            margin-bottom: 2px;
            white-space: nowrap;
        }

        .round-id-compact {
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 0.5px;
            word-break: break-all;
            text-align: center;
            font-family: 'Courier New', monospace;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .saldo {
            background: #f8f9fa;
            border: 2px dashed #d70000;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .saldo-amount {
            font-size: 24px;
            font-weight: bold;
            color: #d70000;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-box {
            background: #f0f7ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .status-title {
            font-size: 11px;
            color: #0066cc;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pilihan-container {
            margin-bottom: 20px;
        }

        .pilihan-buttons {
            display: flex;
            gap: 15px;
        }

        .pilihan-btn {
            flex: 1;
            padding: 25px 10px;
            border: none;
            border-radius: 12px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            position: relative;
            overflow: hidden;
        }

        #btn-besar {
            background: linear-gradient(45deg, #d70000, #ff4444);
        }

        #btn-kecil {
            background: linear-gradient(45deg, #0066cc, #0099ff);
        }

        .pilihan-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .pilihan-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pilihan-btn.active {
            transform: scale(1.03);
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.8);
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .bottom-sheet-overlay.active {
            display: block;
        }

        .bottom-sheet-header {
            padding: 20px 20px 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            position: sticky;
            top: 0;
            z-index: 2;
            border-radius: 20px 20px 0 0;
        }

        .bottom-sheet-title {
            font-size: 18px;
            font-weight: bold;
            color: #d70000;
        }

        .bottom-sheet-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .bottom-sheet-close:hover {
            background: #f5f5f5;
        }

        .bottom-sheet-content {
            padding: 20px;
            padding-bottom: 100px;
        }

        .pasangan-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .pasangan-btn {
            background: white;
            border: 2px solid #d70000;
            color: #d70000;
            padding: 12px 5px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .pasangan-btn:hover:not(:disabled) {
            background: #d70000;
            color: white;
        }

        .pasangan-btn.active {
            background: #d70000;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 3px 8px rgba(215, 0, 0, 0.3);
        }

        .pasangan-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .custom-pasangan {
            margin-bottom: 20px;
        }

        .custom-pasangan-label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }

        .custom-pasangan-input-group {
            display: flex;
            gap: 10px;
        }

        #custom-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #d70000;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            caret-color: #d70000;
        }

        #custom-input:focus {
            outline: none;
            border-color: #ff4444;
            box-shadow: 0 0 0 2px rgba(215, 0, 0, 0.2);
        }

        #custom-btn {
            background: #d70000;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            min-width: 80px;
        }

        .all-in-btn {
            width: 100%;
            background: linear-gradient(45deg, #ff9900, #ff6600);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .all-in-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 153, 0, 0.3);
        }

        .all-in-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .confirm-btn {
            width: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .confirm-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* HASIL ROUND - TANPA CARD TERPISAH */
        .hasil-round-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 25px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        .hasil-round-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }

        .hasil-round-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            align-items: center;
            min-height: 45px;
        }

        .hasil-round-item:hover {
            background: #f9f9f9;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .hasil-round-item.berjalan {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .hasil-round-item.selesai-besar {
            background: rgba(255, 0, 0, 0.05);
            border-left: 4px solid #d70000;
        }

        .hasil-round-item.selesai-kecil {
            background: rgba(0, 102, 204, 0.05);
            border-left: 4px solid #0066cc;
        }

        .hasil-round-item.menang {
            background: rgba(40, 167, 69, 0.1);
            border-left: 4px solid #28a745;
        }

        .hasil-round-item.kalah {
            background: rgba(220, 53, 69, 0.1);
            border-left: 4px solid #dc3545;
        }

        .hasil-round-item.kosong {
            background: #f9f9f9;
            border: 1px dashed #ddd;
            color: #999;
            cursor: default;
        }

        .hasil-round-item.kosong:hover {
            background: #f9f9f9;
            transform: none;
            box-shadow: none;
        }

        /* Container untuk detail */
        .detail-container {
            display: none;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 5px;
            margin-bottom: 8px;
            padding: 15px;
            animation: slideDown 0.3s ease-out;
            grid-column: 1 / span 2;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-container.expanded {
            display: block;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 90%;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            border: 5px solid #ffcc00;
        }

        .popup-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .popup-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #d70000;
            word-break: break-word;
        }

        .popup-details {
            font-size: 14px;
            margin-bottom: 15px;
            text-align: left;
        }

        .popup-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .popup-close:hover {
            background: #f5f5f5;
        }

        .audio-controls {
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .audio-btn {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #d70000;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        .shake {
            animation: shake 0.5s;
        }

        .last5-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 20px;
            z-index: 100;
            display: none;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }

        /* Tombol Unlock Audio */
        #unlock-audio {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2001;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            transition: all 0.3s;
        }

        #unlock-audio:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .arrow {
            display: inline-block;
            transition: transform 0.3s;
            font-size: 18px;
            margin-left: 5px;
        }

        .arrow.expanded {
            transform: rotate(90deg);
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            body {
                padding: 10px;
                padding-bottom: 20px;
            }
            
            .timer-container {
                padding: 6px 10px;
                min-height: 70px;
            }
            
            #timer {
                font-size: 32px;
            }
            
            .timer-label {
                font-size: 10px;
            }
            
            .timer-footer {
                padding: 3px 6px;
            }
            
            .round-id-compact {
                font-size: 9px;
            }
            
            .round-id-label {
                font-size: 8px;
            }
            
            .container {
                padding: 15px;
            }
            
            .status-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .status-box {
                padding: 8px;
            }
            
            .status-title {
                font-size: 10px;
            }
            
            .status-value {
                font-size: 14px;
            }
            
            .pilihan-btn {
                font-size: 20px;
                padding: 20px 5px;
            }
            
            .pasangan-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .pasangan-btn {
                font-size: 13px;
                padding: 10px 3px;
                min-height: 45px;
            }
            
            .bottom-sheet-content {
                padding: 15px;
                padding-bottom: 90px;
            }
            
            .all-in-btn, .confirm-btn {
                padding: 14px;
                font-size: 16px;
            }
            
            .hasil-round-header {
                padding: 8px;
                font-size: 12px;
                margin-top: 20px;
            }
            
            .hasil-round-items {
                max-height: 350px;
            }
            
            .hasil-round-item {
                padding: 10px;
                font-size: 13px;
                min-height: 44px;
            }
            
            .popup-content {
                max-width: 95%;
                width: 95%;
                padding: 20px;
            }
            
            .popup-title {
                font-size: 18px;
            }
            
            .popup-details {
                font-size: 13px;
            }
            
            #unlock-audio {
                padding: 8px 16px;
                font-size: 14px;
                top: 5px;
            }
        }

        @media (max-width: 350px) {
            #timer {
                font-size: 28px;
            }
            
            .timer-container {
                padding: 5px 8px;
                min-height: 65px;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .pasangan-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pasangan-btn {
                font-size: 12px;
                min-height: 40px;
            }
            
            .hasil-round-items {
                max-height: 320px;
            }
        }
    </style>
</head>
<body>
    <!-- Tombol Unlock Audio - WAJIB untuk interaksi user -->
    <button id="unlock-audio" style="display: none;">
        üîì UNLOCK AUDIO
    </button>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div style="text-align:center;">
            <div style="font-size:24px; margin-bottom:20px; color:#d70000;">Loading...</div>
            <div style="width:50px; height:50px; border:5px solid #f3f3f3; border-top:5px solid #d70000; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto;"></div>
        </div>
    </div>

    <!-- Element Audio dengan URL yang diminta -->
    <audio id="countdownAudio" preload="auto">
        <source src="https://raw.githubusercontent.com/ojekaGorontalo/lotre/main/countdown.mp3" type="audio/mpeg">
    </audio>

    <div class="last5-warning" id="last5-warning">‚è∞ 5 DETIK TERAKHIR!</div>

    <div class="popup-overlay" id="popup-overlay">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup()">√ó</button>
            <div class="popup-icon" id="popup-icon"></div>
            <div class="popup-title" id="popup-title"></div>
            <div class="popup-details" id="popup-details"></div>
        </div>
    </div>

    <div class="bottom-sheet-overlay" id="bottom-sheet-overlay" onclick="closeBottomSheet()"></div>

    <div class="bottom-sheet" id="bottom-sheet">
        <div class="bottom-sheet-header">
            <div class="bottom-sheet-title">PILIH PASANGAN</div>
            <button class="bottom-sheet-close" onclick="closeBottomSheet()">√ó</button>
        </div>
        <div class="bottom-sheet-content">
            <div class="pasangan-grid" id="pasangan-grid"></div>
            
            <div class="custom-pasangan">
                <label class="custom-pasangan-label">Atur Pasangan Custom:</label>
                <div class="custom-pasangan-input-group">
                    <input type="number" id="custom-input" placeholder="Min. 100" min="100" step="100" 
                           inputmode="numeric">
                    <button id="custom-btn" onclick="setCustomPasangan()">SET</button>
                </div>
            </div>
            
            <button class="all-in-btn" onclick="setAllIn()" id="all-in-btn">ALL IN üöÄ</button>
            
            <button class="confirm-btn" onclick="konfirmasiPasangan()" id="confirm-btn">
                KONFIRMASI PASANGAN
            </button>
        </div>
    </div>

    <div class="container">
        <div class="audio-controls" style="display: none;">
            <button class="audio-btn" onclick="toggleAudio()">üîä</button>
        </div>

        <div class="header">
            <h1>üéØ TEBAK BESAR KECIL</h1>
            <div class="subtitle">Big or Small</div>
        </div>

        <!-- TIMER CONTAINER BARU YANG LEBIH SIMPLE -->
        <div class="timer-container">
            <div class="timer-header">
                <div class="timer-label">TIME</div>
                <div id="timer">15</div>
            </div>
            <div class="timer-footer">
                <div class="round-id-label">ROUND ID:</div>
                <div id="round-id" class="round-id-compact">-</div>
            </div>
        </div>

        <div class="saldo">
            <div>Saldo Anda:</div>
            <div class="saldo-amount" id="saldo">Rp 50,000</div>
        </div>

        <div class="status-grid">
            <div class="status-box">
                <div class="status-title">PASANGAN</div>
                <div class="status-value" id="status-pasangan">-</div>
            </div>
            <div class="status-box">
                <div class="status-title">TEBAKAN</div>
                <div class="status-value" id="status-tebakan">-</div>
            </div>
        </div>

        <div class="pilihan-container">
            <div class="pilihan-buttons">
                <button id="btn-besar" class="pilihan-btn" onclick="pilih('BESAR')">
                    BESAR üü•
                </button>
                <button id="btn-kecil" class="pilihan-btn" onclick="pilih('KECIL')">
                    KECIL üü¶
                </button>
            </div>
        </div>

        <!-- HASIL ROUND - TANPA CARD TERPISAH -->
        <div class="hasil-round-header">
            <div>PERIODE</div>
            <div>HASIL</div>
        </div>
        
        <div class="hasil-round-items" id="hasil-round-items">
            <!-- Data akan dimuat di sini dengan JavaScript -->
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDtZxsl5LZp3n1KZJfdVAdqQj22ZBPoQbU",
            authDomain: "steady-fin-368617.firebaseapp.com",
            databaseURL: "https://steady-fin-368617-default-rtdb.firebaseio.com",
            projectId: "steady-fin-368617",
            storageBucket: "steady-fin-368617.firebasestorage.app",
            messagingSenderId: "626971902484",
            appId: "1:626971902484:web:98f7cdbd55c5990dfe9d01",
            measurementId: "G-70D3LR995Y"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Variabel untuk sistem audio yang baru
        let state = {
            userId: null,
            roundId: null,
            pasanganDipilih: null,
            pilihanDipilih: null,
            timer: 15,
            timerInterval: null,
            saldo: 50000,
            bisaMemilih: true,
            audioEnabled: true,
            audioUnlocked: false,
            countdownPlayed: false,
            waktuTunggu: 15,
            taruhanRef: null,
            roundRef: null,
            roundListener: null,
            processingResult: false,
            last5Seconds: false,
            hasilRoundListener: null,
            hasilRoundData: [],
            gameMode: 'BESAR_KECIL',
            bottomSheetOpen: false,
            pasanganOptions: [1000, 2000, 5000, 10000, 20000, 50000],
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            expandedDetailId: null
        };

        const countdownAudio = document.getElementById('countdownAudio');
        const bottomSheet = document.getElementById('bottom-sheet');
        const bottomSheetOverlay = document.getElementById('bottom-sheet-overlay');
        const customInput = document.getElementById('custom-input');

        // ============================================
        // FUNGSI UNLOCK AUDIO - WAJIB USER INTERACTION
        // ============================================
        function unlockAudio() {
            try {
                console.log("üîì Mencoba unlock audio...");
                
                // Pastikan audio dimuat
                countdownAudio.load();
                
                // Coba play dengan volume 0 untuk unlock (Chrome Android requirement)
                countdownAudio.volume = 0;
                const playPromise = countdownAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log("‚úÖ Audio berhasil di-unlock");
                        
                        // Hentikan audio, reset ke awal, set volume normal
                        countdownAudio.pause();
                        countdownAudio.currentTime = 0;
                        countdownAudio.volume = 1;
                        
                        // Set flag audioUnlocked ke true
                        state.audioUnlocked = true;
                        
                        // Sembunyikan tombol unlock
                        document.getElementById('unlock-audio').style.display = 'none';
                        
                        // Tampilkan tombol audio controls (mute/unmute)
                        document.querySelector('.audio-controls').style.display = 'block';
                        
                        // Aktifkan audio secara default
                        state.audioEnabled = true;
                        document.querySelector('.audio-btn').textContent = 'üîä';
                        
                        // Simpan status di localStorage
                        localStorage.setItem('audioUnlocked_bk', 'true');
                        
                    }).catch(e => {
                        console.log("‚ùå Gagal unlock audio:", e.name);
                        alert("Gagal unlock audio. Silakan coba lagi atau periksa izin browser.");
                    });
                }
            } catch (error) {
                console.error("Error unlock audio:", error);
                alert("Terjadi error saat unlock audio.");
            }
        }

        // ============================================
        // FUNGSI PLAY COUNTDOWN AUDIO 5 DETIK TERAKHIR
        // ============================================
        function playCountdownAudio() {
            // CEK KONDISI WAJIB: audioUnlocked harus true
            if (!state.audioUnlocked) {
                console.log("üîí Audio belum di-unlock");
                return;
            }
            
            // CEK KONDISI WAJIB: audioEnabled (user bisa matikan)
            if (!state.audioEnabled) {
                console.log("üîá Audio dimatikan oleh user");
                return;
            }
            
            // CEK KONDISI WAJIB: countdownPlayed false (hanya 1x per round)
            if (state.countdownPlayed) {
                console.log("üéµ Audio sudah diputar untuk round ini");
                return;
            }
            
            // CEK KONDISI WAJIB: timer dalam range 5-1 detik
            if (state.timer > 5 || state.timer <= 0) {
                return;
            }
            
            try {
                console.log("üéµ Memutar audio countdown (timer:", state.timer, ")");
                
                // Reset audio ke awal
                countdownAudio.currentTime = 0;
                countdownAudio.volume = 0.7;
                
                // Coba play audio
                const playPromise = countdownAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log("‚úÖ Audio countdown berhasil diputar");
                        state.countdownPlayed = true; // Set flag sudah diputar
                    }).catch(error => {
                        console.log("‚ùå Gagal memutar audio:", error.name);
                        
                        // Jika gagal karena NotAllowedError, reset status unlock
                        if (error.name === 'NotAllowedError') {
                            state.audioUnlocked = false;
                            document.getElementById('unlock-audio').style.display = 'block';
                            document.querySelector('.audio-controls').style.display = 'none';
                            localStorage.removeItem('audioUnlocked_bk');
                        }
                    });
                }
            } catch (error) {
                console.error("Error play audio:", error);
            }
        }

        // ============================================
        // FUNGSI TOGGLE AUDIO (MUTE/UNMUTE)
        // ============================================
        function toggleAudio() {
            // Cek apakah audio sudah di-unlock
            if (!state.audioUnlocked) {
                alert("Silakan unlock audio terlebih dahulu dengan tombol 'UNLOCK AUDIO'");
                return;
            }
            
            // Toggle status audioEnabled
            state.audioEnabled = !state.audioEnabled;
            const audioBtn = document.querySelector('.audio-btn');
            
            if (state.audioEnabled) {
                audioBtn.textContent = 'üîä';
                console.log("üîä Audio diaktifkan");
            } else {
                audioBtn.textContent = 'üîá';
                console.log("üîá Audio dimatikan");
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Cek status unlock audio dari localStorage
            const savedAudioUnlocked = localStorage.getItem('audioUnlocked_bk');
            if (savedAudioUnlocked === 'true') {
                state.audioUnlocked = true;
                document.getElementById('unlock-audio').style.display = 'none';
                document.querySelector('.audio-controls').style.display = 'block';
            } else {
                // Tampilkan tombol unlock audio
                document.getElementById('unlock-audio').style.display = 'block';
                document.querySelector('.audio-controls').style.display = 'none';
            }
            
            // Setup event listener untuk tombol unlock
            document.getElementById('unlock-audio').addEventListener('click', unlockAudio);
            
            // Lanjutkan inisialisasi aplikasi
            await initAplikasi();
            setupEventListeners();
            loadHasilRound();
            loadPasanganSettings();
        });

        function setupEventListeners() {
            customInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    setCustomPasangan();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && state.bottomSheetOpen) {
                    closeBottomSheet();
                }
            });
        }

        function generateRoundId() {
            const now = new Date();
            const jam = String(now.getHours()).padStart(2, '0');
            const menit = String(now.getMinutes()).padStart(2, '0');
            const tanggal = String(now.getDate()).padStart(2, '0');
            const bulan = String(now.getMonth() + 1).padStart(2, '0');
            const tahun = now.getFullYear();
            const random = Math.floor(100000 + Math.random() * 900000);
            
            return `${tahun}${bulan}${tanggal}-${jam}${menit}-${random}`;
        }

        function getUserId() {
            let userId = localStorage.getItem('user_id_bk');
            if (!userId) {
                if (confirm('Anda belum login. Ingin login sekarang?')) {
                    window.location.href = 'login.html';
                    return null;
                } else {
                    userId = 'temp_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                    localStorage.setItem('user_id_bk', userId);
                    
                    database.ref(`tebak-angka/saldo/${userId}`).set(50000);
                }
            }
            return userId;
        }

        async function initSaldo() {
            try {
                const userId = state.userId;
                
                if (!userId) {
                    state.saldo = 50000;
                    updateSaldo();
                    return;
                }
                
                if (userId.startsWith('temp_')) {
                    const saldoRef = database.ref('tebak-angka/saldo/' + userId);
                    const snapshot = await saldoRef.once('value');
                    
                    if (!snapshot.exists()) {
                        await saldoRef.set(50000);
                        state.saldo = 50000;
                    } else {
                        const saldoValue = snapshot.val();
                        state.saldo = saldoValue;
                        
                        if (!saldoValue || saldoValue < 0 || saldoValue === null) {
                            await saldoRef.set(50000);
                            state.saldo = 50000;
                        }
                    }
                } else {
                    const saldoRef = database.ref('tebak-angka/saldo/' + userId);
                    const snapshot = await saldoRef.once('value');
                    
                    if (!snapshot.exists()) {
                        await saldoRef.set(50000);
                        state.saldo = 50000;
                    } else {
                        const saldoValue = snapshot.val();
                        state.saldo = saldoValue;
                        
                        if (!saldoValue || saldoValue < 0 || saldoValue === null) {
                            await saldoRef.set(50000);
                            state.saldo = 50000;
                        }
                    }
                }
                
                updateSaldo();
            } catch (error) {
                console.error("Error init saldo:", error);
                state.saldo = 50000;
                updateSaldo();
            }
        }

        async function loadAturan() {
            try {
                const aturanRef = database.ref('tebak-angka/aturan');
                const snapshot = await aturanRef.once('value');
                
                if (snapshot.exists()) {
                    const aturan = snapshot.val();
                    if (aturan.waktu_tunggu) {
                        state.waktuTunggu = aturan.waktu_tunggu;
                        state.timer = state.waktuTunggu;
                        document.getElementById('timer').textContent = state.timer;
                    }
                }
            } catch (error) {
                console.error("Error load aturan:", error);
            }
        }

        async function loadPasanganSettings() {
            try {
                const pasanganRef = database.ref('tebak-angka/pasangan');
                const snapshot = await pasanganRef.once('value');
                
                if (snapshot.exists()) {
                    const pasanganData = snapshot.val();
                    if (Array.isArray(pasanganData)) {
                        state.pasanganOptions = pasanganData;
                    } else {
                        state.pasanganOptions = Object.values(pasanganData);
                    }
                }
                
                if (state.pasanganOptions.length < 6) {
                    state.pasanganOptions = [1000, 2000, 5000, 10000, 20000, 50000];
                }
                
                updatePasanganGrid();
            } catch (error) {
                console.error("Error load pasangan settings:", error);
                updatePasanganGrid();
            }
        }

        function updatePasanganGrid() {
            const pasanganGrid = document.getElementById('pasangan-grid');
            pasanganGrid.innerHTML = '';
            
            const displayOptions = state.pasanganOptions.slice(0, 6);
            
            displayOptions.forEach(pasangan => {
                const button = document.createElement('button');
                button.className = 'pasangan-btn';
                button.textContent = `Rp ${pasangan.toLocaleString()}`;
                button.onclick = () => pilihPasangan(pasangan, button);
                pasanganGrid.appendChild(button);
            });
            
            updateAllInButton();
        }

        function setupFirebaseListeners() {
            database.ref('tebak-angka/aturan').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const aturan = snapshot.val();
                    if (aturan.waktu_tunggu) {
                        state.waktuTunggu = aturan.waktu_tunggu;
                    }
                }
            });

            database.ref('tebak-angka/pasangan').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const pasanganData = snapshot.val();
                    if (Array.isArray(pasanganData)) {
                        state.pasanganOptions = pasanganData;
                    } else {
                        state.pasanganOptions = Object.values(pasanganData);
                    }
                    updatePasanganGrid();
                }
            });

            const userId = getUserId();
            if (userId) {
                database.ref('tebak-angka/saldo/' + userId).on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const saldo = snapshot.val();
                        if (saldo !== null) {
                            state.saldo = saldo;
                            updateSaldo();
                            updateAllInButton();
                            console.log("üîÑ Saldo diperbarui dari Firebase: Rp", saldo.toLocaleString());
                        }
                    }
                });
            }
        }

        // ============================================
        // LOAD HASIL ROUND DARI TEBAK-ANGKA/TARUHAN
        // ============================================
        function loadHasilRound() {
            if (state.hasilRoundListener) {
                database.ref('tebak-angka/taruhan').off('value', state.hasilRoundListener);
            }
            
            state.hasilRoundListener = database.ref('tebak-angka/taruhan')
                .orderByChild('created_at')
                .limitToLast(10)
                .on('value', (snapshot) => {
                    console.log("üìä Load data round dari taruhan:", snapshot.numChildren(), "item ditemukan");
                    
                    state.hasilRoundData = [];
                    
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const items = Object.entries(data)
                            .map(([roundId, item]) => ({ roundId, ...item }))
                            .sort((a, b) => b.created_at - a.created_at);
                        
                        state.hasilRoundData = items;
                        updateHasilRoundUI();
                    } else {
                        state.hasilRoundData = [];
                        updateHasilRoundUI();
                    }
                }, (error) => {
                    console.error("Error loading hasil round:", error);
                });
        }

        // ============================================
        // UPDATE UI HASIL ROUND (2 KOLOM: PERIODE & HASIL)
        // ============================================
        function updateHasilRoundUI() {
            const container = document.getElementById('hasil-round-items');
            
            // Kosongkan container
            container.innerHTML = '';
            
            // Tampilkan 10 baris (data atau placeholder)
            for (let i = 0; i < 10; i++) {
                const item = state.hasilRoundData[i];
                
                if (item) {
                    const roundId = item.roundId;
                    const roundData = item;
                    
                    // Tentukan teks hasil
                    let hasilText = '';
                    let emoji = '';
                    let cssClass = '';
                    
                    if (roundData.status === 'berjalan') {
                        hasilText = 'BERJALAN';
                        emoji = 'üîÑ';
                        cssClass = 'berjalan';
                    } else if (roundData.status === 'selesai' && roundData.hasil) {
                        hasilText = roundData.hasil;
                        emoji = roundData.hasil === 'BESAR' ? 'üü•' : 'üü¶';
                        cssClass = roundData.hasil === 'BESAR' ? 'selesai-besar' : 'selesai-kecil';
                        
                        // Cek apakah user ikut taruhan
                        if (roundData.taruhan_users && state.userId && roundData.taruhan_users[state.userId]) {
                            const taruhan = roundData.taruhan_users[state.userId];
                            if (taruhan.status === 'menang') {
                                cssClass = 'menang';
                                hasilText += ' - MENANG üéâ';
                            } else if (taruhan.status === 'kalah') {
                                cssClass = 'kalah';
                                hasilText += ' - KALAH üíî';
                            } else if (taruhan.status === 'menunggu') {
                                hasilText += ' - MENUNGGU ‚è≥';
                            }
                        }
                    } else {
                        hasilText = 'TIDAK ADA DATA';
                        emoji = '‚ùì';
                    }
                    
                    // Buat elemen item
                    const itemElement = document.createElement('div');
                    itemElement.className = `hasil-round-item ${cssClass}`;
                    itemElement.setAttribute('data-round-id', roundId);
                    itemElement.setAttribute('data-index', i);
                    itemElement.onclick = function() { toggleRoundDetail(this, roundId, roundData); };
                    
                    itemElement.innerHTML = `
                        <div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 2px;">#${i+1}</div>
                            <div style="font-weight: bold; font-size: 14px;">${roundData.round_id || roundId}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; font-size: 14px;">
                                ${emoji} ${hasilText}
                            </div>
                            <div style="font-size: 11px; color: #666; margin-top: 2px;">
                                Klik untuk detail <span class="arrow">‚Ä∫</span>
                            </div>
                        </div>
                    `;
                    
                    // Buat container untuk detail
                    const detailElement = document.createElement('div');
                    detailElement.className = 'detail-container';
                    detailElement.id = `detail-${roundId}`;
                    
                    // Tambahkan ke container
                    container.appendChild(itemElement);
                    container.appendChild(detailElement);
                } else {
                    // Baris kosong/placeholder jika tidak ada data
                    const itemElement = document.createElement('div');
                    itemElement.className = 'hasil-round-item kosong';
                    
                    itemElement.innerHTML = `
                        <div>
                            <div style="font-size: 11px; color: #999; margin-bottom: 2px;">#${i+1}</div>
                            <div style="font-weight: bold; font-size: 14px; color: #ccc;">---</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; font-size: 14px; color: #ccc;">
                                ---
                            </div>
                            <div style="font-size: 11px; color: #ccc; margin-top: 2px;">
                                -
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(itemElement);
                }
            }
        }

        async function initAplikasi() {
            try {
                document.getElementById('loading-screen').style.display = 'flex';
                document.querySelector('.container').classList.remove('loaded');
                
                state.userId = getUserId();
                console.log("User ID:", state.userId);
                
                if (!state.userId) {
                    return;
                }
                
                await initSaldo();
                await loadAturan();
                setupFirebaseListeners();
                await findOrCreateRound();
                
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.querySelector('.container').classList.add('loaded');
                }, 1000);
                
            } catch (error) {
                console.error("Error init aplikasi:", error);
                alert("Gagal menginisialisasi aplikasi. Refresh halaman.");
                
                document.getElementById('loading-screen').style.display = 'none';
                document.querySelector('.container').classList.add('loaded');
            }
        }

        async function findOrCreateRound() {
            try {
                const snapshot = await database.ref('tebak-angka/taruhan').once('value');
                
                if (snapshot.exists()) {
                    const rounds = snapshot.val();
                    const now = Date.now();
                    
                    for (const roundId in rounds) {
                        const round = rounds[roundId];
                        if (round.status === 'berjalan' && round.end_time && round.end_time > now) {
                            await setupRound(roundId, round);
                            return;
                        }
                    }
                }
                
                await buatRoundBaru();
            } catch (error) {
                console.error("Error find or create round:", error);
                setTimeout(() => findOrCreateRound(), 2000);
            }
        }

        async function setupRound(roundId, roundData) {
            clearInterval(state.timerInterval);
            
            if (state.roundListener && state.roundRef) {
                state.roundRef.off('value', state.roundListener);
            }
            
            state.roundId = roundId;
            state.roundRef = database.ref('tebak-angka/taruhan/' + roundId);
            resetStateUntukRoundBaru();
            document.getElementById('last5-warning').style.display = 'none';
            document.getElementById('round-id').textContent = roundId;
            
            state.roundListener = state.roundRef.on('value', async (snapshot) => {
                await handleRoundUpdate(snapshot);
            });
            
            const now = Date.now();
            const endTime = roundData.end_time || (now + (state.waktuTunggu * 1000));
            const timeLeft = Math.max(0, Math.floor((endTime - now) / 1000));
            state.timer = timeLeft;
            startTimer();
        }

        async function buatRoundBaru() {
            try {
                state.roundId = generateRoundId();
                state.roundRef = database.ref('tebak-angka/taruhan/' + state.roundId);
                
                const now = Date.now();
                const endTime = now + (state.waktuTunggu * 1000);
                
                await state.roundRef.set({
                    round_id: state.roundId,
                    status: 'berjalan',
                    hasil: null,
                    start_time: now,
                    end_time: endTime,
                    waktu_tunggu: state.waktuTunggu,
                    created_at: now,
                    mode: state.gameMode.toLowerCase()
                });
                
                await setupRound(state.roundId, {
                    end_time: endTime,
                    status: 'berjalan'
                });
                
                console.log("Round baru dibuat:", state.roundId);
            } catch (error) {
                console.error("Error buat round baru:", error);
                setTimeout(() => buatRoundBaru(), 2000);
            }
        }

        async function handleRoundUpdate(snapshot) {
            if (!snapshot.exists()) return;
            
            const roundData = snapshot.val();
            
            if (roundData.status === 'berjalan' && roundData.end_time) {
                const timeLeft = Math.max(0, Math.floor((roundData.end_time - Date.now()) / 1000));
                if (timeLeft !== state.timer && timeLeft <= state.waktuTunggu) {
                    state.timer = timeLeft;
                    document.getElementById('timer').textContent = state.timer;
                }
            }
            
            if (roundData.status === 'selesai' && roundData.hasil && !state.processingResult) {
                await processRoundResultFromAdmin(roundData.hasil);
            }
        }

        function resetStateUntukRoundBaru() {
            // Reset pilihan dan pasangan
            state.pasanganDipilih = null;
            state.pilihanDipilih = null;
            state.bisaMemilih = true;
            state.processingResult = false;
            state.last5Seconds = false;
            
            // RESET FLAG COUNTDOWN PLAYED - PENTING!
            state.countdownPlayed = false;
            console.log("üîÑ countdownPlayed direset untuk round baru");
            
            // Update UI
            document.getElementById('status-pasangan').textContent = '-';
            document.getElementById('status-tebakan').textContent = '-';
            document.getElementById('btn-besar').classList.remove('active');
            document.getElementById('btn-kecil').classList.remove('active');
            document.getElementById('btn-besar').disabled = false;
            document.getElementById('btn-kecil').disabled = false;
            
            // Tutup bottom sheet
            closeBottomSheet();
            resetBottomSheet();
            
            console.log("State direset untuk round baru");
        }

        function resetBottomSheet() {
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            customInput.value = '';
            document.getElementById('confirm-btn').disabled = true;
        }

        function updateAllInButton() {
            const allInBtn = document.getElementById('all-in-btn');
            if (state.saldo >= 100) {
                allInBtn.textContent = `ALL IN üöÄ (Rp ${state.saldo.toLocaleString()})`;
                allInBtn.disabled = false;
            } else {
                allInBtn.textContent = 'SALDO TIDAK CUKUP';
                allInBtn.disabled = true;
            }
        }

        function pilih(pilihan) {
            if (!state.bisaMemilih || state.last5Seconds) {
                return;
            }
            
            if (state.pilihanDipilih === pilihan) {
                state.pilihanDipilih = null;
                document.getElementById(`btn-${pilihan.toLowerCase()}`).classList.remove('active');
                document.getElementById('status-tebakan').textContent = '-';
            } else {
                state.pilihanDipilih = pilihan;
                document.getElementById('btn-besar').classList.remove('active');
                document.getElementById('btn-kecil').classList.remove('active');
                document.getElementById(`btn-${pilihan.toLowerCase()}`).classList.add('active');
                document.getElementById('status-tebakan').textContent = pilihan;
                
                openBottomSheet();
            }
        }

        function openBottomSheet() {
            state.bottomSheetOpen = true;
            
            let title = 'PILIH PASANGAN';
            if (state.pilihanDipilih) {
                title = `PASANGAN UNTUK ${state.pilihanDipilih}`;
            }
            
            document.querySelector('.bottom-sheet-title').textContent = title;
            
            bottomSheet.classList.add('active');
            bottomSheetOverlay.classList.add('active');
            
            resetBottomSheet();
        }

        function closeBottomSheet() {
            state.bottomSheetOpen = false;
            bottomSheet.classList.remove('active');
            bottomSheetOverlay.classList.remove('active');
            
            if (!state.pasanganDipilih && state.pilihanDipilih) {
                document.getElementById('confirm-btn').disabled = true;
            }
            
            if (customInput === document.activeElement) {
                customInput.blur();
            }
        }

        function pilihPasangan(jumlah, button) {
            if (state.pasanganDipilih || state.last5Seconds) return;
            if (jumlah > state.saldo) {
                alert('Saldo tidak cukup!');
                return;
            }
            
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            state.pasanganDipilih = jumlah;
            document.getElementById('status-pasangan').textContent = `Rp ${jumlah.toLocaleString()}`;
            
            document.getElementById('confirm-btn').disabled = false;
            
            customInput.value = '';
        }

        function setCustomPasangan() {
            if (state.pasanganDipilih || state.last5Seconds) return;
            
            let jumlah = parseInt(customInput.value);
            
            if (isNaN(jumlah)) {
                alert('Masukkan jumlah yang valid!');
                customInput.focus();
                return;
            }
            
            if (jumlah < 100) {
                alert('Minimal pasangan Rp 100!');
                customInput.value = 100;
                customInput.focus();
                return;
            }
            
            if (jumlah > state.saldo) {
                alert(`Saldo tidak cukup! Saldo Anda: Rp ${state.saldo.toLocaleString()}`);
                customInput.value = state.saldo;
                customInput.focus();
                return;
            }
            
            jumlah = Math.floor(jumlah / 100) * 100;
            
            state.pasanganDipilih = jumlah;
            document.getElementById('status-pasangan').textContent = `Rp ${jumlah.toLocaleString()}`;
            
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('confirm-btn').disabled = false;
        }

        function setAllIn() {
            if (state.pasanganDipilih || state.last5Seconds) return;
            if (state.saldo < 100) {
                alert('Saldo minimal Rp 100 untuk bermain!');
                return;
            }
            
            state.pasanganDipilih = state.saldo;
            document.getElementById('status-pasangan').textContent = `Rp ${state.saldo.toLocaleString()}`;
            
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            customInput.value = '';
            
            document.getElementById('confirm-btn').disabled = false;
        }

        async function konfirmasiPasangan() {
            if (!state.pasanganDipilih || !state.pilihanDipilih || !state.roundId || state.last5Seconds) {
                alert('Pilih tebakan dan pasangan terlebih dahulu!');
                return;
            }

            try {
                const userId = state.userId;
                const pasangan = state.pasanganDipilih;
                
                const saldoSnapshot = await database.ref('tebak-angka/saldo/' + userId).once('value');
                let currentSaldo = saldoSnapshot.val();
                
                if (!currentSaldo || currentSaldo < pasangan) {
                    alert('Saldo tidak cukup!');
                    return;
                }
                
                const newBalance = currentSaldo - pasangan;
                
                await database.ref('tebak-angka/saldo/' + userId).set(newBalance);
                
                state.saldo = newBalance;
                updateSaldo();
                
                state.taruhanRef = database.ref(`tebak-angka/taruhan/${state.roundId}/taruhan_users/${userId}`);
                
                const taruhanData = {
                    user_id: userId,
                    pasangan: pasangan,
                    pilihan: state.pilihanDipilih,
                    status: 'menunggu',
                    waktu_taruhan: Date.now(),
                    hasil: null,
                    saldo_sebelum: currentSaldo,
                    saldo_setelah: newBalance
                };
                
                await state.taruhanRef.set(taruhanData);
                
                state.bisaMemilih = false;
                closeBottomSheet();
                disableAllButtons();
                
                console.log('üí∞ Taruhan berhasil disimpan. Saldo baru:', newBalance);
            } catch (error) {
                console.error('Error menyimpan taruhan:', error);
                alert('Gagal menyimpan taruhan, coba lagi!');
                
                state.pasanganDipilih = null;
                document.getElementById('status-pasangan').textContent = '-';
            }
        }

        function disableAllButtons() {
            document.getElementById('btn-besar').disabled = true;
            document.getElementById('btn-kecil').disabled = true;
        }

        function startTimer() {
            clearInterval(state.timerInterval);
            state.last5Seconds = false;
            
            // RESET FLAG COUNTDOWN PLAYED SETIAP ROUND BARU
            state.countdownPlayed = false;
            console.log("‚è±Ô∏è Timer dimulai, countdownPlayed:", state.countdownPlayed);
            
            document.getElementById('timer').textContent = state.timer;
            document.getElementById('timer').classList.remove('shake');
            document.getElementById('timer').style.color = '';
            document.getElementById('timer').style.textShadow = '';
            
            state.timerInterval = setInterval(async () => {
                state.timer--;
                document.getElementById('timer').textContent = state.timer;
                
                // LOGIC AUDIO COUNTDOWN 5 DETIK TERAKHIR
                if (state.timer <= 5 && state.timer > 0) {
                    if (!state.last5Seconds) {
                        state.last5Seconds = true;
                        showLast5SecondsWarning();
                        
                        // Mainkan audio countdown
                        playCountdownAudio();
                        
                        // Update UI untuk 5 detik terakhir
                        document.getElementById('timer').style.color = '#ff0000';
                        document.getElementById('timer').style.textShadow = '0 0 10px #ff0000';
                    }
                    
                    // Nonaktifkan pilihan saat 5 detik terakhir
                    if (state.bisaMemilih) {
                        disableAllButtons();
                        closeBottomSheet();
                    }
                    
                    document.getElementById('timer').classList.add('pulse');
                }
                
                // Efek shake saat 3 detik terakhir
                if (state.timer <= 3) {
                    document.getElementById('timer').classList.add('shake');
                }
                
                // Timer habis
                if (state.timer <= 0) {
                    clearInterval(state.timerInterval);
                    await waktuHabis();
                }
            }, 1000);
        }

        function showLast5SecondsWarning() {
            const warning = document.getElementById('last5-warning');
            warning.style.display = 'block';
            warning.classList.add('shake');
            
            setTimeout(() => {
                warning.style.display = 'none';
                warning.classList.remove('shake');
            }, 3000);
        }

        async function waktuHabis() {
            try {
                document.getElementById('timer').textContent = "HASIL...";
                
                console.log("‚è≥ Menunggu hasil dari admin panel...");
                
                const hasilListener = state.roundRef.on('value', (snapshot) => {
                    if (!snapshot.exists()) return;
                    
                    const roundData = snapshot.val();
                    
                    if (roundData.status === 'selesai' && roundData.hasil) {
                        state.roundRef.off('value', hasilListener);
                        processRoundResultFromAdmin(roundData.hasil);
                    }
                });
                
                setTimeout(() => {
                    state.roundRef.off('value', hasilListener);
                    console.log("Timeout menunggu hasil dari admin");
                    findOrCreateRound();
                }, 10000);
            } catch (error) {
                console.error("Error waktu habis:", error);
                setTimeout(() => findOrCreateRound(), 2000);
            }
        }

        async function processRoundResultFromAdmin(hasilRound) {
            if (state.processingResult) return;
            state.processingResult = true;
            
            try {
                const taruhanSnapshot = await database.ref(`tebak-angka/taruhan/${state.roundId}/taruhan_users/${state.userId}`).once('value');
                
                if (!taruhanSnapshot.exists()) {
                    console.log("User tidak ikut taruhan di round ini");
                    findOrCreateRound();
                    return;
                }
                
                const taruhanData = taruhanSnapshot.val();
                
                const menang = taruhanData.pilihan === hasilRound;
                
                await database.ref(`tebak-angka/taruhan/${state.roundId}/taruhan_users/${state.userId}`).update({
                    status: menang ? 'menang' : 'kalah',
                    hasil: menang ? 'MENANG' : 'KALAH',
                    waktu_hasil: Date.now()
                });
                
                console.log(`üìä User ${state.userId.substring(0, 8)}...: Menang=${menang}`);
                
                findOrCreateRound();
                
            } catch (error) {
                console.error("Error process round result from admin:", error);
                setTimeout(() => findOrCreateRound(), 2000);
            }
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // ============================================
        // TOGGLE ROUND DETAIL (KLIK UNTUK DETAIL)
        // ============================================
        function toggleRoundDetail(element, roundId, roundData) {
            const detailElement = document.getElementById(`detail-${roundId}`);
            const arrow = element.querySelector('.arrow');
            
            // Jika detail yang sama diklik lagi, tutup
            if (state.expandedDetailId === roundId) {
                detailElement.style.display = 'none';
                detailElement.classList.remove('expanded');
                if (arrow) arrow.classList.remove('expanded');
                state.expandedDetailId = null;
                return;
            }
            
            // Tutup semua detail yang lain
            document.querySelectorAll('.detail-container').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('expanded');
            });
            document.querySelectorAll('.arrow').forEach(el => {
                el.classList.remove('expanded');
            });
            
            // Tampilkan detail yang dipilih
            detailElement.style.display = 'block';
            detailElement.classList.add('expanded');
            if (arrow) arrow.classList.add('expanded');
            state.expandedDetailId = roundId;
            
            // Isi detail
            let detailHTML = `
                <h4 style="margin-bottom: 15px; color: #d70000; border-bottom: 1px solid #eee; padding-bottom: 5px;">DETAIL ROUND</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            `;
            
            // Data dasar round
            const fields = {
                'Periode': roundData.round_id || roundId,
                'Status': roundData.status || '-',
                'Waktu Tunggu': roundData.waktu_tunggu ? `${roundData.waktu_tunggu} detik` : '-',
                'Waktu Mulai': roundData.start_time ? formatDateTime(roundData.start_time) : '-',
                'Waktu Selesai': roundData.end_time ? formatDateTime(roundData.end_time) : '-',
            };
            
            // Tambahkan hasil jika sudah selesai
            if (roundData.status === 'selesai') {
                fields['Hasil'] = roundData.hasil || '-';
                if (roundData.waktu_hasil) {
                    fields['Waktu Hasil'] = formatDateTime(roundData.waktu_hasil);
                }
            }
            
            Object.entries(fields).forEach(([label, value]) => {
                detailHTML += `
                    <div style="padding: 8px; border-bottom: 1px dashed #eee;">
                        <div style="font-size: 12px; color: #666;">${label}</div>
                        <div style="font-weight: bold; font-size: 14px;">${value}</div>
                    </div>
                `;
            });
            
            detailHTML += '</div>';
            
            // Data taruhan user jika ada
            if (state.userId && roundData.taruhan_users && roundData.taruhan_users[state.userId]) {
                const taruhan = roundData.taruhan_users[state.userId];
                detailHTML += `
                    <h4 style="margin-top: 20px; margin-bottom: 15px; color: #0066cc; border-bottom: 1px solid #eee; padding-bottom: 5px;">TARUHAN ANDA</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                `;
                
                const taruhanFields = {
                    'Pilihan': taruhan.pilihan || '-',
                    'Pasangan': taruhan.pasangan ? `Rp ${taruhan.pasangan.toLocaleString()}` : '-',
                    'Status': taruhan.status || '-',
                    'Waktu Taruhan': taruhan.waktu_taruhan ? formatDateTime(taruhan.waktu_taruhan) : '-',
                };
                
                // Tambahkan data hasil jika ada
                if (taruhan.hasil) {
                    taruhanFields['Hasil'] = taruhan.hasil;
                }
                if (taruhan.kemenangan) {
                    taruhanFields['Kemenangan'] = `Rp ${taruhan.kemenangan.toLocaleString()}`;
                }
                if (taruhan.saldo_netto) {
                    taruhanFields['Saldo Netto'] = `Rp ${taruhan.saldo_netto.toLocaleString()}`;
                }
                if (taruhan.saldo_sebelum) {
                    taruhanFields['Saldo Sebelum'] = `Rp ${taruhan.saldo_sebelum.toLocaleString()}`;
                }
                if (taruhan.saldo_setelah) {
                    taruhanFields['Saldo Setelah'] = `Rp ${taruhan.saldo_setelah.toLocaleString()}`;
                }
                if (taruhan.waktu_hasil) {
                    taruhanFields['Waktu Hasil'] = formatDateTime(taruhan.waktu_hasil);
                }
                
                Object.entries(taruhanFields).forEach(([label, value]) => {
                    detailHTML += `
                        <div style="padding: 8px; border-bottom: 1px dashed #eee;">
                            <div style="font-size: 12px; color: #666;">${label}</div>
                            <div style="font-weight: bold; font-size: 14px;">${value}</div>
                        </div>
                    `;
                });
                
                detailHTML += '</div>';
            }
            
            detailElement.innerHTML = detailHTML;
        }

        function updateSaldo() {
            const saldoElement = document.getElementById('saldo');
            saldoElement.textContent = `Rp ${state.saldo.toLocaleString()}`;
            
            if (state.saldo < 0) {
                saldoElement.style.color = '#dc3545';
            } else {
                saldoElement.style.color = '#d70000';
            }
            
            updateAllInButton();
        }

        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
        }

        window.resetSaldo = async function() {
            if (confirm("Reset saldo ke Rp 50,000?")) {
                await database.ref('tebak-angka/saldo/' + state.userId).set(50000);
                state.saldo = 50000;
                updateSaldo();
            }
        };
    </script>
</body>
</html>
