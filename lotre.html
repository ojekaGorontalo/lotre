<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tebak Besar Kecil</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #d70000 0%, #8b0000 100%);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 120px;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 4px solid #ffcc00;
            position: relative;
            overflow: visible;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .container.loaded {
            opacity: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffcc00;
        }

        h1 {
            color: #d70000;
            font-size: 26px;
            font-weight: bold;
        }

        .subtitle {
            color: #666;
            font-size: 12px;
            margin-top: 3px;
        }

        .timer-container {
            background: linear-gradient(45deg, #d70000, #8b0000);
            color: white;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.4);
        }

        #timer {
            font-size: 42px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin: 5px 0;
        }

        .timer-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .round-id-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
        }

        #round-id {
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .saldo {
            background: #f8f9fa;
            border: 2px dashed #d70000;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .saldo-amount {
            font-size: 24px;
            font-weight: bold;
            color: #d70000;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-box {
            background: #f0f7ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .status-title {
            font-size: 11px;
            color: #0066cc;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pilihan-container {
            margin-bottom: 20px;
        }

        .pilihan-buttons {
            display: flex;
            gap: 15px;
        }

        .pilihan-btn {
            flex: 1;
            padding: 25px 10px;
            border: none;
            border-radius: 12px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            position: relative;
            overflow: hidden;
        }

        #btn-besar {
            background: linear-gradient(45deg, #d70000, #ff4444);
        }

        #btn-kecil {
            background: linear-gradient(45deg, #0066cc, #0099ff);
        }

        .pilihan-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .pilihan-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pilihan-btn.active {
            transform: scale(1.03);
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.8);
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .bottom-sheet-overlay.active {
            display: block;
        }

        .bottom-sheet-header {
            padding: 20px 20px 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            position: sticky;
            top: 0;
            z-index: 2;
            border-radius: 20px 20px 0 0;
        }

        .bottom-sheet-title {
            font-size: 18px;
            font-weight: bold;
            color: #d70000;
        }

        .bottom-sheet-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .bottom-sheet-close:hover {
            background: #f5f5f5;
        }

        .bottom-sheet-content {
            padding: 20px;
            padding-bottom: 100px;
        }

        .pasangan-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .pasangan-btn {
            background: white;
            border: 2px solid #d70000;
            color: #d70000;
            padding: 12px 5px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .pasangan-btn:hover:not(:disabled) {
            background: #d70000;
            color: white;
        }

        .pasangan-btn.active {
            background: #d70000;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 3px 8px rgba(215, 0, 0, 0.3);
        }

        .pasangan-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .custom-pasangan {
            margin-bottom: 20px;
        }

        .custom-pasangan-label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }

        .custom-pasangan-input-group {
            display: flex;
            gap: 10px;
        }

        #custom-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #d70000;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            caret-color: #d70000;
        }

        #custom-input:focus {
            outline: none;
            border-color: #ff4444;
            box-shadow: 0 0 0 2px rgba(215, 0, 0, 0.2);
        }

        #custom-btn {
            background: #d70000;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            min-width: 80px;
        }

        .all-in-btn {
            width: 100%;
            background: linear-gradient(45deg, #ff9900, #ff6600);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .all-in-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 153, 0, 0.3);
        }

        .all-in-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .confirm-btn {
            width: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .confirm-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hasil-round-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background: #f9f9f9;
            margin-top: 15px;
        }

        .hasil-round-item {
            margin-bottom: 8px;
            border-radius: 6px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .hasil-round-item.besar {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(215, 0, 0, 0.2);
        }

        .hasil-round-item.kecil {
            background: rgba(0, 102, 204, 0.1);
            border: 1px solid rgba(0, 102, 204, 0.2);
        }

        .hasil-round-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .hasil-round-header:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .hasil-round-header .arrow {
            transition: transform 0.3s;
            font-size: 18px;
            color: #666;
        }

        .hasil-round-header.expanded .arrow {
            transform: rotate(90deg);
        }

        .hasil-round-detail {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: white;
        }

        .hasil-round-detail.expanded {
            max-height: 500px;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .detail-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: bold;
            color: #666;
            width: 40%;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        .pagination-btn {
            background: #d70000;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            margin: 0 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .page-info {
            margin: 0 15px;
            font-size: 14px;
            color: #666;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 90%;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            border: 5px solid #ffcc00;
        }

        .popup-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .popup-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #d70000;
            word-break: break-word;
        }

        .popup-details {
            font-size: 14px;
            margin-bottom: 15px;
            text-align: left;
        }

        .popup-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .popup-close:hover {
            background: #f5f5f5;
        }

        .audio-controls {
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .audio-btn {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #d70000;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        .shake {
            animation: shake 0.5s;
        }

        .last5-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 20px;
            z-index: 100;
            display: none;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #ffcc00;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            flex: 1;
            padding: 8px 0;
            transition: all 0.3s;
        }

        .nav-item.active {
            color: #d70000;
            transform: translateY(-5px);
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(45deg, #d70000, #ff4444);
            box-shadow: 0 4px 10px rgba(215, 0, 0, 0.3);
        }

        .nav-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: #f0f0f0;
            margin-bottom: 4px;
            transition: all 0.3s;
        }

        .nav-label {
            font-size: 12px;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .popup-content {
                max-width: 95%;
                width: 95%;
                padding: 20px;
            }
            
            .popup-title {
                font-size: 18px;
            }
            
            .popup-details {
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .status-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .status-box {
                padding: 8px;
            }
            
            .status-title {
                font-size: 10px;
            }
            
            .status-value {
                font-size: 14px;
            }
            
            .pilihan-btn {
                font-size: 20px;
                padding: 20px 5px;
            }
            
            .pasangan-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .pasangan-btn {
                font-size: 13px;
                padding: 10px 3px;
                min-height: 45px;
            }
            
            .bottom-sheet-content {
                padding: 15px;
                padding-bottom: 90px;
            }
            
            .all-in-btn, .confirm-btn {
                padding: 14px;
                font-size: 16px;
            }
            
            #round-id {
                font-size: 12px;
            }
            
            .hasil-round-header {
                padding: 10px;
            }
            
            .hasil-round-detail.expanded {
                padding: 10px;
            }
            
            .nav-icon {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }
            
            .nav-label {
                font-size: 10px;
            }
            
            body {
                padding-bottom: 110px !important;
            }
        }

        @media (max-width: 350px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .pasangan-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pasangan-btn {
                font-size: 12px;
                min-height: 40px;
            }
            
            .detail-table {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div style="text-align:center;">
            <div style="font-size:24px; margin-bottom:20px; color:#d70000;">Loading...</div>
            <div style="width:50px; height:50px; border:5px solid #f3f3f3; border-top:5px solid #d70000; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto;"></div>
        </div>
    </div>

    <audio id="countdownAudio" preload="auto">
        <source src="https://drive.google.com/uc?export=download&id=16BfcfJ5EFNsk1y0_xZFQn9gUt8xFgWf-" type="audio/mpeg">
    </audio>

    <div class="last5-warning" id="last5-warning">‚è∞ 5 DETIK TERAKHIR!</div>

    <div class="popup-overlay" id="popup-overlay">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup()">√ó</button>
            <div class="popup-icon" id="popup-icon"></div>
            <div class="popup-title" id="popup-title"></div>
            <div class="popup-details" id="popup-details"></div>
        </div>
    </div>

    <div class="bottom-sheet-overlay" id="bottom-sheet-overlay" onclick="closeBottomSheet()"></div>

    <div class="bottom-sheet" id="bottom-sheet">
        <div class="bottom-sheet-header">
            <div class="bottom-sheet-title">PILIH PASANGAN</div>
            <button class="bottom-sheet-close" onclick="closeBottomSheet()">√ó</button>
        </div>
        <div class="bottom-sheet-content">
            <div class="pasangan-grid" id="pasangan-grid"></div>
            
            <div class="custom-pasangan">
                <label class="custom-pasangan-label">Atur Pasangan Custom:</label>
                <div class="custom-pasangan-input-group">
                    <input type="number" id="custom-input" placeholder="Min. 100" min="100" step="100" 
                           inputmode="numeric">
                    <button id="custom-btn" onclick="setCustomPasangan()">SET</button>
                </div>
            </div>
            
            <button class="all-in-btn" onclick="setAllIn()" id="all-in-btn">ALL IN üöÄ</button>
            
            <button class="confirm-btn" onclick="konfirmasiPasangan()" id="confirm-btn">
                KONFIRMASI PASANGAN
            </button>
        </div>
    </div>

    <div class="container">
        <div class="audio-controls">
            <button class="audio-btn" onclick="toggleAudio()">üîä</button>
        </div>

        <div class="header">
            <h1>üéØ TEBAK BESAR KECIL</h1>
            <div class="subtitle">BESAR (5-9) | KECIL (0-4)</div>
        </div>

        <div class="timer-container">
            <div class="timer-label">WAKTU TERSISA:</div>
            <div id="timer">15</div>
            <div class="timer-label">Round ID:</div>
            <div class="round-id-container">
                <span id="round-id">-</span>
            </div>
        </div>

        <div class="saldo">
            <div>Saldo Anda:</div>
            <div class="saldo-amount" id="saldo">Rp 50,000</div>
        </div>

        <div class="status-grid">
            <div class="status-box">
                <div class="status-title">PASANGAN</div>
                <div class="status-value" id="status-pasangan">-</div>
            </div>
            <div class="status-box">
                <div class="status-title">TEBAKAN</div>
                <div class="status-value" id="status-tebakan">-</div>
            </div>
        </div>

        <div class="pilihan-container">
            <div class="pilihan-buttons">
                <button id="btn-besar" class="pilihan-btn" onclick="pilih('BESAR')">
                    BESAR üü•
                </button>
                <button id="btn-kecil" class="pilihan-btn" onclick="pilih('KECIL')">
                    KECIL üü¶
                </button>
            </div>
        </div>

        <div class="hasil-round-container" id="hasil-round-list">
            <div class="hasil-round-item">üîÑ Menunggu hasil round...</div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="lotre.html" class="nav-item active">
            <div class="nav-icon">üéØ</div>
            <div class="nav-label">Besar/Kecil</div>
        </a>
        <a href="tebak-angka.html" class="nav-item">
            <div class="nav-icon">üî¢</div>
            <div class="nav-label">Tebak Angka</div>
        </a>
        <a href="riwayat.html" class="nav-item">
            <div class="nav-icon">üìã</div>
            <div class="nav-label">Riwayat</div>
        </a>
        <a href="akun.html" class="nav-item">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">Akun</div>
        </a>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDtZxsl5LZp3n1KZJfdVAdqQj22ZBPoQbU",
            authDomain: "steady-fin-368617.firebaseapp.com",
            databaseURL: "https://steady-fin-368617-default-rtdb.firebaseio.com",
            projectId: "steady-fin-368617",
            storageBucket: "steady-fin-368617.firebasestorage.app",
            messagingSenderId: "626971902484",
            appId: "1:626971902484:web:98f7cdbd55c5990dfe9d01",
            measurementId: "G-70D3LR995Y"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let state = {
            userId: null,
            roundId: null,
            pasanganDipilih: null,
            pilihanDipilih: null,
            timer: 15,
            timerInterval: null,
            saldo: 50000,
            bisaMemilih: true,
            audioEnabled: true,
            waktuTunggu: 15,
            taruhanRef: null,
            roundRef: null,
            roundListener: null,
            processingResult: false,
            last5Seconds: false,
            hasilRoundListener: null,
            hasilRoundList: [],
            gameMode: 'BESAR_KECIL',
            bottomSheetOpen: false,
            pasanganOptions: [1000, 2000, 5000, 10000, 20000, 50000],
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            countdownPlayed: false
        };

        // Pagination state
        let hasilRoundPagination = {
            currentPage: 1,
            itemsPerPage: 10,
            totalItems: 0,
            totalPages: 1
        };

        const countdownAudio = document.getElementById('countdownAudio');
        const bottomSheet = document.getElementById('bottom-sheet');
        const bottomSheetOverlay = document.getElementById('bottom-sheet-overlay');
        const customInput = document.getElementById('custom-input');

        let audioInitialized = false;
        let audioUnlockAttempted = false;

        document.addEventListener('DOMContentLoaded', async function() {
            await initAplikasi();
            setupEventListeners();
            loadHasilRound();
            loadPasanganSettings();
            countdownAudio.load();
        });

        function setupEventListeners() {
            customInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    setCustomPasangan();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && state.bottomSheetOpen) {
                    closeBottomSheet();
                }
            });
        }

        function generateRoundId() {
            const now = new Date();
            const jam = String(now.getHours()).padStart(2, '0');
            const menit = String(now.getMinutes()).padStart(2, '0');
            const tanggal = String(now.getDate()).padStart(2, '0');
            const bulan = String(now.getMonth() + 1).padStart(2, '0');
            const tahun = now.getFullYear();
            const random = Math.floor(100000 + Math.random() * 900000);
            
            return `RBK${tahun}${bulan}${tanggal}-${jam}${menit}-${random}`;
        }

        function getUserId() {
            let userId = localStorage.getItem('user_id_bk');
            if (!userId) {
                // Redirect ke halaman login jika belum login
                if (confirm('Anda belum login. Ingin login sekarang?')) {
                    window.location.href = 'login.html';
                    return null;
                } else {
                    // Buat user temporary
                    userId = 'temp_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                    localStorage.setItem('user_id_bk', userId);
                    
                    // Set saldo default untuk temporary user di Firebase
                    database.ref(`tebak-angka/saldo/${userId}`).set(50000);
                }
            }
            return userId;
        }

        async function initSaldo() {
            try {
                const userId = state.userId;
                
                if (!userId) {
                    state.saldo = 50000;
                    updateSaldo();
                    return;
                }
                
                // Cek apakah user temporary
                if (userId.startsWith('temp_')) {
                    const saldoRef = database.ref('tebak-angka/saldo/' + userId);
                    const snapshot = await saldoRef.once('value');
                    
                    if (!snapshot.exists()) {
                        await saldoRef.set(50000);
                        state.saldo = 50000;
                    } else {
                        const saldoValue = snapshot.val();
                        state.saldo = saldoValue;
                        
                        if (!saldoValue || saldoValue < 0 || saldoValue === null) {
                            await saldoRef.set(50000);
                            state.saldo = 50000;
                        }
                    }
                } else {
                    // User terdaftar - cek di Firebase
                    const saldoRef = database.ref('tebak-angka/saldo/' + userId);
                    const snapshot = await saldoRef.once('value');
                    
                    if (!snapshot.exists()) {
                        // Jika tidak ada saldo, buat baru dengan 50000
                        await saldoRef.set(50000);
                        state.saldo = 50000;
                    } else {
                        const saldoValue = snapshot.val();
                        state.saldo = saldoValue;
                        
                        // Validasi saldo
                        if (!saldoValue || saldoValue < 0 || saldoValue === null) {
                            await saldoRef.set(50000);
                            state.saldo = 50000;
                        }
                    }
                }
                
                updateSaldo();
            } catch (error) {
                console.error("Error init saldo:", error);
                state.saldo = 50000;
                updateSaldo();
            }
        }

        async function loadAturan() {
            try {
                const aturanRef = database.ref('tebak-angka/aturan');
                const snapshot = await aturanRef.once('value');
                
                if (snapshot.exists()) {
                    const aturan = snapshot.val();
                    if (aturan.waktu_tunggu) {
                        state.waktuTunggu = aturan.waktu_tunggu;
                        state.timer = state.waktuTunggu;
                        document.getElementById('timer').textContent = state.timer;
                    }
                }
            } catch (error) {
                console.error("Error load aturan:", error);
            }
        }

        async function loadPasanganSettings() {
            try {
                const pasanganRef = database.ref('tebak-angka/pasangan');
                const snapshot = await pasanganRef.once('value');
                
                if (snapshot.exists()) {
                    const pasanganData = snapshot.val();
                    if (Array.isArray(pasanganData)) {
                        state.pasanganOptions = pasanganData;
                    } else {
                        state.pasanganOptions = Object.values(pasanganData);
                    }
                }
                
                if (state.pasanganOptions.length < 6) {
                    state.pasanganOptions = [1000, 2000, 5000, 10000, 20000, 50000];
                }
                
                updatePasanganGrid();
            } catch (error) {
                console.error("Error load pasangan settings:", error);
                updatePasanganGrid();
            }
        }

        function updatePasanganGrid() {
            const pasanganGrid = document.getElementById('pasangan-grid');
            pasanganGrid.innerHTML = '';
            
            const displayOptions = state.pasanganOptions.slice(0, 6);
            
            displayOptions.forEach(pasangan => {
                const button = document.createElement('button');
                button.className = 'pasangan-btn';
                button.textContent = `Rp ${pasangan.toLocaleString()}`;
                button.onclick = () => pilihPasangan(pasangan, button);
                pasanganGrid.appendChild(button);
            });
            
            updateAllInButton();
        }

        function setupFirebaseListeners() {
            database.ref('tebak-angka/aturan').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const aturan = snapshot.val();
                    if (aturan.waktu_tunggu) {
                        state.waktuTunggu = aturan.waktu_tunggu;
                    }
                }
            });

            database.ref('tebak-angka/pasangan').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const pasanganData = snapshot.val();
                    if (Array.isArray(pasanganData)) {
                        state.pasanganOptions = pasanganData;
                    } else {
                        state.pasanganOptions = Object.values(pasanganData);
                    }
                    updatePasanganGrid();
                }
            });

            // Listener untuk saldo di Firebase
            const userId = getUserId();
            if (userId) {
                database.ref('tebak-angka/saldo/' + userId).on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const saldo = snapshot.val();
                        if (saldo !== null) {
                            state.saldo = saldo;
                            updateSaldo();
                            updateAllInButton();
                            console.log("üîÑ Saldo diperbarui dari Firebase: Rp", saldo.toLocaleString());
                        }
                    }
                });
            }
        }

        function loadHasilRound() {
            if (state.hasilRoundListener) {
                database.ref('tebak-angka/hasil_round').off('value', state.hasilRoundListener);
            }
            
            state.hasilRoundListener = database.ref('tebak-angka/hasil_round')
                .orderByChild('timestamp')
                .limitToLast(hasilRoundPagination.itemsPerPage)
                .on('value', (snapshot) => {
                    console.log("Hasil Round Data:", snapshot.val());
                    updateHasilRoundUI(snapshot.val());
                }, (error) => {
                    console.error("Error loading hasil round:", error);
                });
        }

        async function initAplikasi() {
            try {
                // Tampilkan loading
                document.getElementById('loading-screen').style.display = 'flex';
                document.querySelector('.container').classList.remove('loaded');
                
                state.userId = getUserId();
                console.log("User ID:", state.userId);
                
                if (!state.userId) {
                    return; // Redirect sudah dilakukan di getUserId()
                }
                
                await initSaldo();
                await loadAturan();
                setupFirebaseListeners();
                await findOrCreateRound();
                
                // Sembunyikan loading setelah semua selesai
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.querySelector('.container').classList.add('loaded');
                }, 1000);
                
            } catch (error) {
                console.error("Error init aplikasi:", error);
                alert("Gagal menginisialisasi aplikasi. Refresh halaman.");
                
                // Tetap sembunyikan loading jika error
                document.getElementById('loading-screen').style.display = 'none';
                document.querySelector('.container').classList.add('loaded');
            }
        }

        async function findOrCreateRound() {
            try {
                const snapshot = await database.ref('tebak-angka/taruhan').once('value');
                
                if (snapshot.exists()) {
                    const rounds = snapshot.val();
                    const now = Date.now();
                    
                    for (const roundId in rounds) {
                        const round = rounds[roundId];
                        if (round.status === 'berjalan' && round.end_time && round.end_time > now) {
                            await setupRound(roundId, round);
                            return;
                        }
                    }
                }
                
                await buatRoundBaru();
            } catch (error) {
                console.error("Error find or create round:", error);
                setTimeout(() => findOrCreateRound(), 2000);
            }
        }

        async function setupRound(roundId, roundData) {
            clearInterval(state.timerInterval);
            
            if (state.roundListener && state.roundRef) {
                state.roundRef.off('value', state.roundListener);
            }
            
            state.roundId = roundId;
            state.roundRef = database.ref('tebak-angka/taruhan/' + roundId);
            resetStateUntukRoundBaru();
            document.getElementById('last5-warning').style.display = 'none';
            document.getElementById('round-id').textContent = roundId;
            
            state.roundListener = state.roundRef.on('value', async (snapshot) => {
                await handleRoundUpdate(snapshot);
            });
            
            const now = Date.now();
            const endTime = roundData.end_time || (now + (state.waktuTunggu * 1000));
            const timeLeft = Math.max(0, Math.floor((endTime - now) / 1000));
            state.timer = timeLeft;
            startTimer();
        }

        async function buatRoundBaru() {
            try {
                state.roundId = generateRoundId();
                state.roundRef = database.ref('tebak-angka/taruhan/' + state.roundId);
                
                const now = Date.now();
                const endTime = now + (state.waktuTunggu * 1000);
                
                await state.roundRef.set({
                    round_id: state.roundId,
                    status: 'berjalan',
                    hasil: null,
                    start_time: now,
                    end_time: endTime,
                    waktu_tunggu: state.waktuTunggu,
                    created_at: now,
                    mode: state.gameMode.toLowerCase()
                });
                
                await setupRound(state.roundId, {
                    end_time: endTime,
                    status: 'berjalan'
                });
                
                console.log("Round baru dibuat:", state.roundId);
            } catch (error) {
                console.error("Error buat round baru:", error);
                setTimeout(() => buatRoundBaru(), 2000);
            }
        }

        async function handleRoundUpdate(snapshot) {
            if (!snapshot.exists()) return;
            
            const roundData = snapshot.val();
            
            if (roundData.status === 'berjalan' && roundData.end_time) {
                const timeLeft = Math.max(0, Math.floor((roundData.end_time - Date.now()) / 1000));
                if (timeLeft !== state.timer && timeLeft <= state.waktuTunggu) {
                    state.timer = timeLeft;
                    document.getElementById('timer').textContent = state.timer;
                }
            }
            
            if (roundData.status === 'selesai' && roundData.hasil && !state.processingResult) {
                await processRoundResultFromAdmin(roundData.hasil);
            }
        }

        function resetStateUntukRoundBaru() {
            state.pasanganDipilih = null;
            state.pilihanDipilih = null;
            state.bisaMemilih = true;
            state.processingResult = false;
            state.last5Seconds = false;
            state.countdownPlayed = false;
            
            document.getElementById('status-pasangan').textContent = '-';
            document.getElementById('status-tebakan').textContent = '-';
            document.getElementById('btn-besar').classList.remove('active');
            document.getElementById('btn-kecil').classList.remove('active');
            document.getElementById('btn-besar').disabled = false;
            document.getElementById('btn-kecil').disabled = false;
            
            closeBottomSheet();
            resetBottomSheet();
            
            console.log("State direset untuk round baru");
        }

        function resetBottomSheet() {
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            customInput.value = '';
            document.getElementById('confirm-btn').disabled = true;
        }

        function updateAllInButton() {
            const allInBtn = document.getElementById('all-in-btn');
            if (state.saldo >= 100) {
                allInBtn.textContent = `ALL IN üöÄ (Rp ${state.saldo.toLocaleString()})`;
                allInBtn.disabled = false;
            } else {
                allInBtn.textContent = 'SALDO TIDAK CUKUP';
                allInBtn.disabled = true;
            }
        }

        function pilih(pilihan) {
            if (!state.bisaMemilih || state.last5Seconds) {
                return;
            }
            
            if (state.pilihanDipilih === pilihan) {
                state.pilihanDipilih = null;
                document.getElementById(`btn-${pilihan.toLowerCase()}`).classList.remove('active');
                document.getElementById('status-tebakan').textContent = '-';
            } else {
                state.pilihanDipilih = pilihan;
                document.getElementById('btn-besar').classList.remove('active');
                document.getElementById('btn-kecil').classList.remove('active');
                document.getElementById(`btn-${pilihan.toLowerCase()}`).classList.add('active');
                document.getElementById('status-tebakan').textContent = pilihan;
                
                openBottomSheet();
            }
        }

        function openBottomSheet() {
            state.bottomSheetOpen = true;
            
            let title = 'PILIH PASANGAN';
            if (state.pilihanDipilih) {
                title = `PASANGAN UNTUK ${state.pilihanDipilih}`;
            }
            
            document.querySelector('.bottom-sheet-title').textContent = title;
            
            bottomSheet.classList.add('active');
            bottomSheetOverlay.classList.add('active');
            
            resetBottomSheet();
        }

        function closeBottomSheet() {
            state.bottomSheetOpen = false;
            bottomSheet.classList.remove('active');
            bottomSheetOverlay.classList.remove('active');
            
            if (!state.pasanganDipilih && state.pilihanDipilih) {
                document.getElementById('confirm-btn').disabled = true;
            }
            
            if (customInput === document.activeElement) {
                customInput.blur();
            }
        }

        function pilihPasangan(jumlah, button) {
            if (state.pasanganDipilih || state.last5Seconds) return;
            if (jumlah > state.saldo) {
                alert('Saldo tidak cukup!');
                return;
            }
            
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            state.pasanganDipilih = jumlah;
            document.getElementById('status-pasangan').textContent = `Rp ${jumlah.toLocaleString()}`;
            
            document.getElementById('confirm-btn').disabled = false;
            
            customInput.value = '';
        }

        function setCustomPasangan() {
            if (state.pasanganDipilih || state.last5Seconds) return;
            
            let jumlah = parseInt(customInput.value);
            
            if (isNaN(jumlah)) {
                alert('Masukkan jumlah yang valid!');
                customInput.focus();
                return;
            }
            
            if (jumlah < 100) {
                alert('Minimal pasangan Rp 100!');
                customInput.value = 100;
                customInput.focus();
                return;
            }
            
            if (jumlah > state.saldo) {
                alert(`Saldo tidak cukup! Saldo Anda: Rp ${state.saldo.toLocaleString()}`);
                customInput.value = state.saldo;
                customInput.focus();
                return;
            }
            
            jumlah = Math.floor(jumlah / 100) * 100;
            
            state.pasanganDipilih = jumlah;
            document.getElementById('status-pasangan').textContent = `Rp ${jumlah.toLocaleString()}`;
            
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('confirm-btn').disabled = false;
        }

        function setAllIn() {
            if (state.pasanganDipilih || state.last5Seconds) return;
            if (state.saldo < 100) {
                alert('Saldo minimal Rp 100 untuk bermain!');
                return;
            }
            
            state.pasanganDipilih = state.saldo;
            document.getElementById('status-pasangan').textContent = `Rp ${state.saldo.toLocaleString()}`;
            
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            customInput.value = '';
            
            document.getElementById('confirm-btn').disabled = false;
        }

        async function konfirmasiPasangan() {
            if (!state.pasanganDipilih || !state.pilihanDipilih || !state.roundId || state.last5Seconds) {
                alert('Pilih tebakan dan pasangan terlebih dahulu!');
                return;
            }

            try {
                // PERBAIKAN: POTONG SALDO SECARA REALTIME
                const userId = state.userId;
                const pasangan = state.pasanganDipilih;
                
                // Get current balance from Firebase
                const saldoSnapshot = await database.ref('tebak-angka/saldo/' + userId).once('value');
                let currentSaldo = saldoSnapshot.val();
                
                if (!currentSaldo || currentSaldo < pasangan) {
                    alert('Saldo tidak cukup!');
                    return;
                }
                
                // Calculate new balance
                const newBalance = currentSaldo - pasangan;
                
                // Update saldo di Firebase
                await database.ref('tebak-angka/saldo/' + userId).set(newBalance);
                
                // Update saldo lokal
                state.saldo = newBalance;
                updateSaldo();
                
                // Simpan taruhan
                state.taruhanRef = database.ref(`tebak-angka/taruhan/${state.roundId}/taruhan_users/${userId}`);
                
                const taruhanData = {
                    user_id: userId,
                    pasangan: pasangan,
                    pilihan: state.pilihanDipilih,
                    status: 'menunggu',
                    waktu_taruhan: Date.now(),
                    hasil: null,
                    saldo_sebelum: currentSaldo,
                    saldo_setelah: newBalance
                };
                
                await state.taruhanRef.set(taruhanData);
                
                state.bisaMemilih = false;
                closeBottomSheet();
                disableAllButtons();
                
                console.log('üí∞ Taruhan berhasil disimpan. Saldo baru:', newBalance);
            } catch (error) {
                console.error('Error menyimpan taruhan:', error);
                alert('Gagal menyimpan taruhan, coba lagi!');
                
                // Reset jika gagal
                state.pasanganDipilih = null;
                document.getElementById('status-pasangan').textContent = '-';
            }
        }

        function disableAllButtons() {
            document.getElementById('btn-besar').disabled = true;
            document.getElementById('btn-kecil').disabled = true;
        }

        function startTimer() {
            clearInterval(state.timerInterval);
            state.last5Seconds = false;
            state.countdownPlayed = false;
            document.getElementById('timer').textContent = state.timer;
            document.getElementById('timer').classList.remove('shake');
            document.getElementById('timer').style.color = '';
            document.getElementById('timer').style.textShadow = '';
            
            state.timerInterval = setInterval(async () => {
                state.timer--;
                document.getElementById('timer').textContent = state.timer;
                
                if (state.timer <= 5 && state.timer > 0) {
                    if (!state.last5Seconds) {
                        state.last5Seconds = true;
                        showLast5SecondsWarning();
                        
                        if (!state.countdownPlayed && audioInitialized && state.audioEnabled) {
                            playCountdownAudio();
                            state.countdownPlayed = true;
                        } else {
                            document.getElementById('timer').style.color = '#ff0000';
                            document.getElementById('timer').style.textShadow = '0 0 10px #ff0000';
                        }
                        
                        if (state.bisaMemilih) {
                            disableAllButtons();
                            closeBottomSheet();
                        }
                    }
                    
                    document.getElementById('timer').classList.add('pulse');
                }
                
                if (state.timer <= 3) {
                    document.getElementById('timer').classList.add('shake');
                }
                
                if (state.timer <= 0) {
                    clearInterval(state.timerInterval);
                    await waktuHabis();
                }
            }, 1000);
        }

        function playCountdownAudio() {
            if (!state.audioEnabled || !audioInitialized) {
                console.log("Audio disabled or not initialized");
                return;
            }
            
            try {
                countdownAudio.currentTime = 0;
                countdownAudio.volume = 0.5;
                
                const playPromise = countdownAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(e => {
                        console.log("Audio play failed:", e.name);
                    });
                }
            } catch (error) {
                console.log("Play audio error:", error);
            }
        }

        function showLast5SecondsWarning() {
            const warning = document.getElementById('last5-warning');
            warning.style.display = 'block';
            warning.classList.add('shake');
            
            setTimeout(() => {
                warning.style.display = 'none';
                warning.classList.remove('shake');
            }, 3000);
        }

        async function waktuHabis() {
            try {
                document.getElementById('timer').textContent = "HASIL...";
                
                console.log("‚è≥ Menunggu hasil dari admin panel...");
                
                const hasilListener = state.roundRef.on('value', (snapshot) => {
                    if (!snapshot.exists()) return;
                    
                    const roundData = snapshot.val();
                    
                    if (roundData.status === 'selesai' && roundData.hasil) {
                        state.roundRef.off('value', hasilListener);
                        processRoundResultFromAdmin(roundData.hasil);
                    }
                });
                
                setTimeout(() => {
                    state.roundRef.off('value', hasilListener);
                    console.log("Timeout menunggu hasil dari admin");
                    findOrCreateRound();
                }, 10000);
            } catch (error) {
                console.error("Error waktu habis:", error);
                setTimeout(() => findOrCreateRound(), 2000);
            }
        }

        async function processRoundResultFromAdmin(hasilRound) {
            if (state.processingResult) return;
            state.processingResult = true;
            
            try {
                const taruhanSnapshot = await database.ref(`tebak-angka/taruhan/${state.roundId}/taruhan_users/${state.userId}`).once('value');
                
                if (!taruhanSnapshot.exists()) {
                    console.log("User tidak ikut taruhan di round ini");
                    findOrCreateRound();
                    return;
                }
                
                const taruhanData = taruhanSnapshot.val();
                
                const menang = taruhanData.pilihan === hasilRound;
                
                // Update status taruhan (saldo sudah diupdate oleh admin panel)
                await database.ref(`tebak-angka/taruhan/${state.roundId}/taruhan_users/${state.userId}`).update({
                    status: menang ? 'menang' : 'kalah',
                    hasil: menang ? 'MENANG' : 'KALAH',
                    waktu_hasil: Date.now()
                });
                
                console.log(`üìä User ${state.userId.substring(0, 8)}...: Menang=${menang}`);
                
                findOrCreateRound();
                
            } catch (error) {
                console.error("Error process round result from admin:", error);
                setTimeout(() => findOrCreateRound(), 2000);
            }
        }

        // Fungsi untuk format tanggal
        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Fungsi untuk update tampilan hasil round dengan pagination
        function updateHasilRoundUI(hasilRoundData) {
            const container = document.getElementById('hasil-round-list');
            if (!hasilRoundData) {
                container.innerHTML = '<div class="hasil-round-item">üîÑ Menunggu hasil round...</div>';
                return;
            }
            
            // Konversi ke array dan sort
            const items = Object.entries(hasilRoundData)
                .map(([roundId, data]) => ({ roundId, ...data }))
                .sort((a, b) => b.timestamp - a.timestamp);
            
            // Hitung pagination
            hasilRoundPagination.totalItems = items.length;
            hasilRoundPagination.totalPages = Math.max(1, Math.ceil(items.length / hasilRoundPagination.itemsPerPage));
            
            // Ambil data untuk halaman saat ini
            const startIndex = (hasilRoundPagination.currentPage - 1) * hasilRoundPagination.itemsPerPage;
            const endIndex = startIndex + hasilRoundPagination.itemsPerPage;
            const currentItems = items.slice(startIndex, endIndex);
            
            let html = '';
            
            if (currentItems.length === 0) {
                html = '<div class="hasil-round-item">üîÑ Tidak ada data round...</div>';
            } else {
                currentItems.forEach(item => {
                    const roundId = item.roundId;
                    const emoji = item.hasil === 'BESAR' ? 'üü•' : 'üü¶';
                    const timestamp = item.timestamp ? formatDateTime(item.timestamp) : '-';
                    
                    html += `
                        <div class="hasil-round-item ${item.hasil === 'BESAR' ? 'besar' : 'kecil'}">
                            <div class="hasil-round-header" onclick="toggleRoundDetail('${roundId}', this)">
                                <div style="flex:1;">
                                    <div><strong>Periode:</strong> ${roundId}</div>
                                    <div><strong>Hasil:</strong> ${item.hasil} ${emoji}</div>
                                    <div style="font-size:10px; color:#666; margin-top:3px;">${timestamp}</div>
                                </div>
                                <div class="arrow">></div>
                            </div>
                            <div class="hasil-round-detail" id="detail-${roundId}">
                                <!-- Detail akan diload saat di-expand -->
                            </div>
                        </div>
                    `;
                });
                
                // Tambahkan pagination
                html += `
                    <div class="pagination">
                        <button class="pagination-btn" onclick="changePage(-1)" ${hasilRoundPagination.currentPage === 1 ? 'disabled' : ''}>
                            &lt;
                        </button>
                        <div class="page-info">
                            ${hasilRoundPagination.currentPage} / ${hasilRoundPagination.totalPages}
                        </div>
                        <button class="pagination-btn" onclick="changePage(1)" ${hasilRoundPagination.currentPage === hasilRoundPagination.totalPages ? 'disabled' : ''}>
                            &gt;
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // Fungsi untuk toggle detail round
        async function toggleRoundDetail(roundId, headerElement) {
            const detailElement = document.getElementById(`detail-${roundId}`);
            const isExpanded = detailElement.classList.contains('expanded');
            
            // Collapse semua detail lain
            document.querySelectorAll('.hasil-round-detail').forEach(el => {
                el.classList.remove('expanded');
                el.innerHTML = '';
            });
            document.querySelectorAll('.hasil-round-header').forEach(el => {
                el.classList.remove('expanded');
            });
            
            if (!isExpanded) {
                headerElement.classList.add('expanded');
                
                // Tampilkan loading
                detailElement.innerHTML = '<div style="padding:20px; text-align:center;">Loading...</div>';
                detailElement.classList.add('expanded');
                
                // Load data detail
                try {
                    const snapshot = await database.ref('tebak-angka/taruhan/' + roundId).once('value');
                    if (!snapshot.exists()) {
                        detailElement.innerHTML = '<div style="padding:20px; text-align:center;">Data tidak ditemukan</div>';
                        return;
                    }
                    
                    const roundData = snapshot.val();
                    let detailHTML = `
                        <table class="detail-table">
                    `;
                    
                    // Tampilkan field-field yang diinginkan
                    const fields = {
                        'Periode': roundData.round_id,
                        'Created At': roundData.created_at ? formatDateTime(roundData.created_at) : '-',
                        'Start Time': roundData.start_time ? formatDateTime(roundData.start_time) : '-',
                        'End Time': roundData.end_time ? formatDateTime(roundData.end_time) : '-',
                        'Waktu Hasil': roundData.waktu_hasil ? formatDateTime(roundData.waktu_hasil) : '-',
                        'Hasil': roundData.hasil || '-',
                        'Status': roundData.status || '-',
                        'Waktu Tunggu': roundData.waktu_tunggu ? `${roundData.waktu_tunggu} detik` : '-'
                    };
                    
                    Object.entries(fields).forEach(([label, value]) => {
                        detailHTML += `
                            <tr>
                                <td class="detail-label">${label}</td>
                                <td>${value}</td>
                            </tr>
                        `;
                    });
                    
                    detailHTML += '</table>';
                    detailElement.innerHTML = detailHTML;
                    
                } catch (error) {
                    console.error('Error loading detail:', error);
                    detailElement.innerHTML = '<div style="padding:20px; text-align:center; color:red;">Error loading detail</div>';
                }
            }
        }

        // Fungsi untuk pagination
        function changePage(direction) {
            const newPage = hasilRoundPagination.currentPage + direction;
            
            if (newPage >= 1 && newPage <= hasilRoundPagination.totalPages) {
                hasilRoundPagination.currentPage = newPage;
                
                // Load ulang data dengan pagination baru
                database.ref('tebak-angka/hasil_round')
                    .orderByChild('timestamp')
                    .limitToLast(hasilRoundPagination.itemsPerPage * newPage)
                    .once('value')
                    .then(snapshot => {
                        updateHasilRoundUI(snapshot.val());
                    });
            }
        }

        function updateSaldo() {
            const saldoElement = document.getElementById('saldo');
            saldoElement.textContent = `Rp ${state.saldo.toLocaleString()}`;
            
            if (state.saldo < 0) {
                saldoElement.style.color = '#dc3545';
            } else {
                saldoElement.style.color = '#d70000';
            }
            
            updateAllInButton();
        }

        function toggleAudio() {
            state.audioEnabled = !state.audioEnabled;
            const audioBtn = document.querySelector('.audio-btn');
            audioBtn.textContent = state.audioEnabled ? 'üîä' : 'üîá';
            
            if (state.audioEnabled && !audioInitialized) {
                unlockAudio();
            }
        }

        function unlockAudio() {
            if (audioUnlockAttempted) return;
            
            audioUnlockAttempted = true;
            console.log("Attempting to unlock audio...");
            
            countdownAudio.volume = 0;
            
            const playPromise = countdownAudio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log(`Audio initialized successfully`);
                    countdownAudio.pause();
                    countdownAudio.currentTime = 0;
                    countdownAudio.volume = 0.5;
                    audioInitialized = true;
                }).catch(e => {
                    console.log(`Audio initialization failed:`, e);
                    audioInitialized = true;
                });
            }
            
            setTimeout(() => {
                if (!audioInitialized) {
                    audioInitialized = true;
                    console.log("Audio unlocked via fallback");
                }
            }, 1000);
        }

        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
        }

        window.resetSaldo = async function() {
            if (confirm("Reset saldo ke Rp 50,000?")) {
                await database.ref('tebak-angka/saldo/' + state.userId).set(50000);
                state.saldo = 50000;
                updateSaldo();
            }
        };
    </script>
</body>
</html>
