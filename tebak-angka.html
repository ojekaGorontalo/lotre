<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tebak Angka</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0066cc 0%, #004080 100%);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 120px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 4px solid #00ccff;
            position: relative;
            overflow: visible;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #00ccff;
        }

        h1 {
            color: #0066cc;
            font-size: 26px;
            font-weight: bold;
        }

        .subtitle {
            color: #666;
            font-size: 12px;
            margin-top: 3px;
        }

        .timer-container {
            background: linear-gradient(45deg, #0066cc, #004080);
            color: white;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4);
        }

        #timer {
            font-size: 42px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin: 5px 0;
        }

        .timer-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .round-id-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
        }

        #round-id {
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .saldo {
            background: #f8f9fa;
            border: 2px dashed #0066cc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .saldo-amount {
            font-size: 24px;
            font-weight: bold;
            color: #0066cc;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-box {
            background: #f0f7ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .status-title {
            font-size: 11px;
            color: #0066cc;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Angka Container */
        .angka-container {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .angka-title {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #0066cc;
            font-size: 16px;
        }

        .angka-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .angka-btn {
            border: none;
            border-radius: 8px;
            padding: 12px 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .angka-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .angka-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            border: 2px solid white;
        }

        .angka-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Warna-warni untuk angka */
        .angka-0 { background: linear-gradient(45deg, #FF6B6B, #FF8E8E); }
        .angka-1 { background: linear-gradient(45deg, #4ECDC4, #88D3CE); }
        .angka-2 { background: linear-gradient(45deg, #FFD166, #FFE0A3); }
        .angka-3 { background: linear-gradient(45deg, #06D6A0, #5CE8C6); }
        .angka-4 { background: linear-gradient(45deg, #118AB2, #4A9CC6); }
        .angka-5 { background: linear-gradient(45deg, #EF476F, #F26B8A); }
        .angka-6 { background: linear-gradient(45deg, #7209B7, #9D4EDD); }
        .angka-7 { background: linear-gradient(45deg, #F8961E, #F9B552); }
        .angka-8 { background: linear-gradient(45deg, #43AA8B, #6DC7B1); }
        .angka-9 { background: linear-gradient(45deg, #277DA1, #4D9BC1); }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .bottom-sheet-overlay.active {
            display: block;
        }

        .bottom-sheet-header {
            padding: 20px 20px 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            position: sticky;
            top: 0;
            z-index: 2;
            border-radius: 20px 20px 0 0;
        }

        .bottom-sheet-title {
            font-size: 18px;
            font-weight: bold;
            color: #0066cc;
        }

        .bottom-sheet-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .bottom-sheet-close:hover {
            background: #f5f5f5;
        }

        .bottom-sheet-content {
            padding: 20px;
        }

        .pasangan-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .pasangan-btn {
            background: white;
            border: 2px solid #0066cc;
            color: #0066cc;
            padding: 12px 5px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .pasangan-btn:hover:not(:disabled) {
            background: #0066cc;
            color: white;
        }

        .pasangan-btn.active {
            background: #0066cc;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 3px 8px rgba(0, 102, 204, 0.3);
        }

        .pasangan-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .custom-pasangan {
            margin-bottom: 20px;
        }

        .custom-pasangan-label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }

        .custom-pasangan-input-group {
            display: flex;
            gap: 10px;
        }

        #custom-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #0066cc;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            caret-color: #0066cc;
        }

        #custom-input:focus {
            outline: none;
            border-color: #0099ff;
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2);
        }

        #custom-btn {
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            min-width: 80px;
        }

        .all-in-btn {
            width: 100%;
            background: linear-gradient(45deg, #ff9900, #ff6600);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .all-in-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 153, 0, 0.3);
        }

        .all-in-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .confirm-btn {
            width: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .confirm-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hasil-round-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background: #f9f9f9;
            margin-top: 15px;
        }

        .hasil-round-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            text-align: left;
            word-break: break-all;
            display: block;
        }

        .hasil-round-item:last-child {
            border-bottom: none;
        }

        .hasil-round-item.angka {
            background: rgba(0, 102, 204, 0.1);
            color: #0066cc;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 350px;
            width: 90%;
            text-align: center;
            border: 5px solid #00ccff;
        }

        .popup-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .popup-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .popup-details {
            font-size: 16px;
            margin-bottom: 15px;
        }

        .popup-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        .audio-controls {
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .audio-btn {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #0066cc;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        .shake {
            animation: shake 0.5s;
        }

        .last5-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 20px;
            z-index: 100;
            display: none;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #00ccff;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            flex: 1;
            padding: 8px 0;
            transition: all 0.3s;
        }

        .nav-item.active {
            color: #0066cc;
            transform: translateY(-5px);
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(45deg, #0066cc, #0099ff);
            box-shadow: 0 4px 10px rgba(0, 102, 204, 0.3);
        }

        .nav-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: #f0f0f0;
            margin-bottom: 4px;
            transition: all 0.3s;
        }

        .nav-label {
            font-size: 12px;
            font-weight: bold;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .status-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .status-box {
                padding: 8px;
            }
            
            .status-title {
                font-size: 10px;
            }
            
            .status-value {
                font-size: 14px;
            }
            
            .angka-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 6px;
            }
            
            .angka-btn {
                font-size: 16px;
                padding: 10px 3px;
                min-height: 45px;
            }
            
            .pasangan-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .pasangan-btn {
                font-size: 13px;
                padding: 10px 3px;
                min-height: 45px;
            }
            
            .bottom-sheet-content {
                padding: 15px;
            }
            
            .all-in-btn, .confirm-btn {
                padding: 14px;
                font-size: 16px;
            }
            
            #round-id {
                font-size: 12px;
            }
            
            .hasil-round-item {
                font-size: 11px;
            }
            
            .nav-icon {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }
            
            .nav-label {
                font-size: 10px;
            }
            
            body {
                padding-bottom: 110px !important;
            }
        }

        @media (max-width: 350px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .pasangan-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pasangan-btn {
                font-size: 12px;
                min-height: 40px;
            }
            
            .angka-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 5px;
            }
            
            .angka-btn {
                font-size: 14px;
                min-height: 40px;
                padding: 8px 2px;
            }
            
            .hasil-round-item {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <audio id="countdownAudio" preload="auto">
        <source src="https://drive.google.com/uc?export=download&id=16BfcfJ5EFNsk1y0_xZFQn9gUt8xFgWf-" type="audio/mpeg">
    </audio>

    <div class="last5-warning" id="last5-warning">‚è∞ 5 DETIK TERAKHIR!</div>

    <div class="popup-overlay" id="popup-overlay">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup()">√ó</button>
            <div class="popup-icon" id="popup-icon"></div>
            <div class="popup-title" id="popup-title"></div>
            <div class="popup-details" id="popup-details"></div>
        </div>
    </div>

    <div class="bottom-sheet-overlay" id="bottom-sheet-overlay" onclick="closeBottomSheet()"></div>

    <div class="bottom-sheet" id="bottom-sheet">
        <div class="bottom-sheet-header">
            <div class="bottom-sheet-title">PILIH PASANGAN</div>
            <button class="bottom-sheet-close" onclick="closeBottomSheet()">√ó</button>
        </div>
        <div class="bottom-sheet-content">
            <div class="pasangan-grid" id="pasangan-grid"></div>
            
            <div class="custom-pasangan">
                <label class="custom-pasangan-label">Atur Pasangan Custom:</label>
                <div class="custom-pasangan-input-group">
                    <input type="number" id="custom-input" placeholder="Min. 100" min="100" step="100" 
                           inputmode="numeric">
                    <button id="custom-btn" onclick="setCustomPasangan()">SET</button>
                </div>
            </div>
            
            <button class="all-in-btn" onclick="setAllIn()" id="all-in-btn">ALL IN üöÄ</button>
            
            <button class="confirm-btn" onclick="konfirmasiPasangan()" id="confirm-btn">
                KONFIRMASI PASANGAN
            </button>
        </div>
    </div>

    <div class="container">
        <div class="audio-controls">
            <button class="audio-btn" onclick="toggleAudio()">üîä</button>
        </div>

        <div class="header">
            <h1>üéØ TEBAK ANGKA (0-9)</h1>
            <div class="subtitle">TEBAK ANGKA DARI 0 SAMPAI 9</div>
        </div>

        <div class="timer-container">
            <div class="timer-label">WAKTU TERSISA:</div>
            <div id="timer">15</div>
            <div class="timer-label">Round ID:</div>
            <div class="round-id-container">
                <span id="round-id">-</span>
            </div>
        </div>

        <div class="saldo">
            <div>Saldo Anda:</div>
            <div class="saldo-amount" id="saldo">Rp 50,000</div>
        </div>

        <div class="status-grid">
            <div class="status-box">
                <div class="status-title">PASANGAN</div>
                <div class="status-value" id="status-pasangan">-</div>
            </div>
            <div class="status-box">
                <div class="status-title">ANGKA TEBAK</div>
                <div class="status-value" id="status-angka">-</div>
            </div>
        </div>

        <!-- Bagian tebakan angka -->
        <div class="angka-container">
            <div class="angka-title">TEBAK ANGKA (0-9)</div>
            <div class="angka-grid">
                <button class="angka-btn angka-0" data-nilai="0" onclick="pilihAngka(0)">0</button>
                <button class="angka-btn angka-1" data-nilai="1" onclick="pilihAngka(1)">1</button>
                <button class="angka-btn angka-2" data-nilai="2" onclick="pilihAngka(2)">2</button>
                <button class="angka-btn angka-3" data-nilai="3" onclick="pilihAngka(3)">3</button>
                <button class="angka-btn angka-4" data-nilai="4" onclick="pilihAngka(4)">4</button>
                <button class="angka-btn angka-5" data-nilai="5" onclick="pilihAngka(5)">5</button>
                <button class="angka-btn angka-6" data-nilai="6" onclick="pilihAngka(6)">6</button>
                <button class="angka-btn angka-7" data-nilai="7" onclick="pilihAngka(7)">7</button>
                <button class="angka-btn angka-8" data-nilai="8" onclick="pilihAngka(8)">8</button>
                <button class="angka-btn angka-9" data-nilai="9" onclick="pilihAngka(9)">9</button>
            </div>
        </div>

        <div class="hasil-round-container" id="hasil-round-list">
            <div class="hasil-round-item">üîÑ Menunggu hasil round...</div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="lotre.html" class="nav-item">
            <div class="nav-icon">üéØ</div>
            <div class="nav-label">Besar/Kecil</div>
        </a>
        <a href="tebak-angka.html" class="nav-item active">
            <div class="nav-icon">üî¢</div>
            <div class="nav-label">Tebak Angka</div>
        </a>
        <a href="riwayat.html" class="nav-item">
            <div class="nav-icon">üìã</div>
            <div class="nav-label">Riwayat</div>
        </a>
        <a href="akun.html" class="nav-item">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">Akun</div>
        </a>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDtZxsl5LZp3n1KZJfdVAdqQj22ZBPoQbU",
            authDomain: "steady-fin-368617.firebaseapp.com",
            databaseURL: "https://steady-fin-368617-default-rtdb.firebaseio.com",
            projectId: "steady-fin-368617",
            storageBucket: "steady-fin-368617.firebasestorage.app",
            messagingSenderId: "626971902484",
            appId: "1:626971902484:web:98f7cdbd55c5990dfe9d01",
            measurementId: "G-70D3LR995Y"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let state = {
            userId: null,
            roundId: null,
            pasanganDipilih: null,
            angkaDipilih: null,
            timer: 15,
            timerInterval: null,
            saldo: 50000,
            bisaMemilih: true,
            audioEnabled: true,
            waktuTunggu: 15,
            taruhanRef: null,
            roundRef: null,
            roundListener: null,
            processingResult: false,
            last5Seconds: false,
            hasilRoundListener: null,
            hasilRoundList: [],
            gameMode: 'TEBAK_ANGKA',
            bottomSheetOpen: false,
            pasanganOptions: [1000, 2000, 5000, 10000, 20000, 50000],
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            countdownPlayed: false
        };

        const countdownAudio = document.getElementById('countdownAudio');
        const bottomSheet = document.getElementById('bottom-sheet');
        const bottomSheetOverlay = document.getElementById('bottom-sheet-overlay');
        const customInput = document.getElementById('custom-input');

        let audioInitialized = false;
        let audioUnlockAttempted = false;

        document.addEventListener('DOMContentLoaded', async function() {
            await initAplikasi();
            setupEventListeners();
            loadHasilRound();
            loadPasanganSettings();
            countdownAudio.load();
        });

        function setupEventListeners() {
            customInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    setCustomPasangan();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && state.bottomSheetOpen) {
                    closeBottomSheet();
                }
            });
        }

        function generateRoundId() {
            const now = new Date();
            const jam = String(now.getHours()).padStart(2, '0');
            const menit = String(now.getMinutes()).padStart(2, '0');
            const tanggal = String(now.getDate()).padStart(2, '0');
            const bulan = String(now.getMonth() + 1).padStart(2, '0');
            const tahun = now.getFullYear();
            const random = Math.floor(100000 + Math.random() * 900000);
            
            return `RTA${tahun}${bulan}${tanggal}-${jam}${menit}-${random}`;
        }

        async function initAplikasi() {
            try {
                state.userId = getUserId();
                console.log("User ID:", state.userId);
                await initSaldo();
                await loadAturan();
                setupFirebaseListeners();
                await findOrCreateRound();
            } catch (error) {
                console.error("Error init aplikasi:", error);
                alert("Gagal menginisialisasi aplikasi. Refresh halaman.");
            }
        }

        async function initSaldo() {
            try {
                const saldoRef = database.ref('tebak-angka/saldo/' + state.userId);
                const snapshot = await saldoRef.once('value');
                
                if (!snapshot.exists()) {
                    await saldoRef.set(50000);
                    state.saldo = 50000;
                } else {
                    const saldoValue = snapshot.val();
                    state.saldo = saldoValue;
                    
                    if (!saldoValue || saldoValue < 0 || saldoValue === null) {
                        await saldoRef.set(50000);
                        state.saldo = 50000;
                    }
                }
                
                updateSaldo();
            } catch (error) {
                console.error("Error init saldo:", error);
                state.saldo = 50000;
                updateSaldo();
            }
        }

        async function loadAturan() {
            try {
                const aturanRef = database.ref('tebak-angka/aturan');
                const snapshot = await aturanRef.once('value');
                
                if (snapshot.exists()) {
                    const aturan = snapshot.val();
                    if (aturan.waktu_tunggu) {
                        state.waktuTunggu = aturan.waktu_tunggu;
                        state.timer = state.waktuTunggu;
                        document.getElementById('timer').textContent = state.timer;
                    }
                }
            } catch (error) {
                console.error("Error load aturan:", error);
            }
        }

        async function loadPasanganSettings() {
            try {
                const pasanganRef = database.ref('tebak-angka/pasangan');
                const snapshot = await pasanganRef.once('value');
                
                if (snapshot.exists()) {
                    const pasanganData = snapshot.val();
                    state.pasanganOptions = Object.values(pasanganData);
                }
                
                if (state.pasanganOptions.length < 6) {
                    state.pasanganOptions = [1000, 2000, 5000, 10000, 20000, 50000];
                }
                
                updatePasanganGrid();
            } catch (error) {
                console.error("Error load pasangan settings:", error);
                updatePasanganGrid();
            }
        }

        function updatePasanganGrid() {
            const pasanganGrid = document.getElementById('pasangan-grid');
            pasanganGrid.innerHTML = '';
            
            const displayOptions = state.pasanganOptions.slice(0, 6);
            
            displayOptions.forEach(pasangan => {
                const button = document.createElement('button');
                button.className = 'pasangan-btn';
                button.textContent = `Rp ${pasangan.toLocaleString()}`;
                button.onclick = () => pilihPasangan(pasangan, button);
                pasanganGrid.appendChild(button);
            });
            
            updateAllInButton();
        }

        function setupFirebaseListeners() {
            database.ref('tebak-angka/aturan').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const aturan = snapshot.val();
                    if (aturan.waktu_tunggu) {
                        state.waktuTunggu = aturan.waktu_tunggu;
                    }
                }
            });

            database.ref('tebak-angka/pasangan').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const pasanganData = snapshot.val();
                    state.pasanganOptions = Object.values(pasanganData);
                    updatePasanganGrid();
                }
            });

            database.ref('tebak-angka/saldo/' + state.userId).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const saldo = snapshot.val();
                    if (saldo !== null) {
                        state.saldo = saldo;
                        updateSaldo();
                        updateAllInButton();
                        console.log("üîÑ Saldo diperbarui dari Firebase: Rp", saldo.toLocaleString());
                    }
                }
            });
        }

        function loadHasilRound() {
            if (state.hasilRoundListener) {
                database.ref('tebak-angka/hasil_round').off('value', state.hasilRoundListener);
            }
            
            state.hasilRoundListener = database.ref('tebak-angka/hasil_round')
                .orderByChild('timestamp')
                .limitToLast(10)
                .on('value', (snapshot) => {
                    updateHasilRoundUI(snapshot.val());
                });
        }

        function getUserId() {
            let userId = localStorage.getItem('user_id_ta');
            if (!userId) {
                userId = 'user_ta_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                localStorage.setItem('user_id_ta', userId);
            }
            return userId;
        }

        async function findOrCreateRound() {
            try {
                const snapshot = await database.ref('tebak-angka/taruhan').once('value');
                
                if (snapshot.exists()) {
                    const rounds = snapshot.val();
                    const now = Date.now();
                    
                    for (const roundId in rounds) {
                        const round = rounds[roundId];
                        if (round.status === 'berjalan' && round.end_time && round.end_time > now) {
                            await setupRound(roundId, round);
                            return;
                        }
                    }
                }
                
                await buatRoundBaru();
            } catch (error) {
                console.error("Error find or create round:", error);
                setTimeout(() => findOrCreateRound(), 2000);
            }
        }

        async function setupRound(roundId, roundData) {
            clearInterval(state.timerInterval);
            
            if (state.roundListener && state.roundRef) {
                state.roundRef.off('value', state.roundListener);
            }
            
            state.roundId = roundId;
            state.roundRef = database.ref('tebak-angka/taruhan/' + roundId);
            resetStateUntukRoundBaru();
            document.getElementById('last5-warning').style.display = 'none';
            document.getElementById('round-id').textContent = roundId;
            
            state.roundListener = state.roundRef.on('value', async (snapshot) => {
                await handleRoundUpdate(snapshot);
            });
            
            const now = Date.now();
            const endTime = roundData.end_time || (now + (state.waktuTunggu * 1000));
            const timeLeft = Math.max(0, Math.floor((endTime - now) / 1000));
            state.timer = timeLeft;
            startTimer();
        }

        async function buatRoundBaru() {
            try {
                state.roundId = generateRoundId();
                state.roundRef = database.ref('tebak-angka/taruhan/' + state.roundId);
                
                const now = Date.now();
                const endTime = now + (state.waktuTunggu * 1000);
                
                await state.roundRef.set({
                    round_id: state.roundId,
                    status: 'berjalan',
                    hasil_angka: null,
                    start_time: now,
                    end_time: endTime,
                    waktu_tunggu: state.waktuTunggu,
                    created_at: now,
                    mode: state.gameMode.toLowerCase()
                });
                
                await setupRound(state.roundId, {
                    end_time: endTime,
                    status: 'berjalan'
                });
                
                console.log("Round baru dibuat:", state.roundId);
            } catch (error) {
                console.error("Error buat round baru:", error);
                setTimeout(() => buatRoundBaru(), 2000);
            }
        }

        async function handleRoundUpdate(snapshot) {
            if (!snapshot.exists()) return;
            
            const roundData = snapshot.val();
            
            if (roundData.status === 'berjalan' && roundData.end_time) {
                const timeLeft = Math.max(0, Math.floor((roundData.end_time - Date.now()) / 1000));
                if (timeLeft !== state.timer && timeLeft <= state.waktuTunggu) {
                    state.timer = timeLeft;
                    document.getElementById('timer').textContent = state.timer;
                }
            }
            
            if (roundData.status === 'selesai' && roundData.hasil_angka !== null && !state.processingResult) {
                await processRoundResultFromAdmin(roundData.hasil_angka);
            }
        }

        function resetStateUntukRoundBaru() {
            state.pasanganDipilih = null;
            state.angkaDipilih = null;
            state.bisaMemilih = true;
            state.processingResult = false;
            state.last5Seconds = false;
            state.countdownPlayed = false;
            
            document.getElementById('status-pasangan').textContent = '-';
            document.getElementById('status-angka').textContent = '-';
            
            document.querySelectorAll('.angka-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.disabled = false;
            });
            
            closeBottomSheet();
            resetBottomSheet();
            
            console.log("State direset untuk round baru");
        }

        function resetBottomSheet() {
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            customInput.value = '';
            document.getElementById('confirm-btn').disabled = true;
        }

        function updateAllInButton() {
            const allInBtn = document.getElementById('all-in-btn');
            if (state.saldo >= 100) {
                allInBtn.textContent = `ALL IN üöÄ (Rp ${state.saldo.toLocaleString()})`;
                allInBtn.disabled = false;
            } else {
                allInBtn.textContent = 'SALDO TIDAK CUKUP';
                allInBtn.disabled = true;
            }
        }

        function pilihAngka(angka) {
            if (!state.bisaMemilih || state.last5Seconds) {
                return;
            }
            
            if (state.angkaDipilih === angka) {
                state.angkaDipilih = null;
                document.querySelector(`.angka-btn[data-nilai="${angka}"]`).classList.remove('active');
                document.getElementById('status-angka').textContent = '-';
            } else {
                state.angkaDipilih = angka;
                document.querySelectorAll('.angka-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.angka-btn[data-nilai="${angka}"]`).classList.add('active');
                document.getElementById('status-angka').textContent = angka;
                
                openBottomSheet();
            }
        }

        function openBottomSheet() {
            state.bottomSheetOpen = true;
            
            let title = 'PILIH PASANGAN';
            if (state.angkaDipilih !== null) {
                title = `PASANGAN UNTUK ANGKA ${state.angkaDipilih}`;
            }
            
            document.querySelector('.bottom-sheet-title').textContent = title;
            
            bottomSheet.classList.add('active');
            bottomSheetOverlay.classList.add('active');
            
            resetBottomSheet();
        }

        function closeBottomSheet() {
            state.bottomSheetOpen = false;
            bottomSheet.classList.remove('active');
            bottomSheetOverlay.classList.remove('active');
            
            if (!state.pasanganDipilih && state.angkaDipilih !== null) {
                document.getElementById('confirm-btn').disabled = true;
            }
            
            if (customInput === document.activeElement) {
                customInput.blur();
            }
        }

        function pilihPasangan(jumlah, button) {
            if (state.pasanganDipilih || state.last5Seconds) return;
            if (jumlah > state.saldo) {
                alert('Saldo tidak cukup!');
                return;
            }
            
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            state.pasanganDipilih = jumlah;
            document.getElementById('status-pasangan').textContent = `Rp ${jumlah.toLocaleString()}`;
            
            document.getElementById('confirm-btn').disabled = false;
            
            customInput.value = '';
        }

        function setCustomPasangan() {
            if (state.pasanganDipilih || state.last5Seconds) return;
            
            let jumlah = parseInt(customInput.value);
            
            if (isNaN(jumlah)) {
                alert('Masukkan jumlah yang valid!');
                customInput.focus();
                return;
            }
            
            if (jumlah < 100) {
                alert('Minimal pasangan Rp 100!');
                customInput.value = 100;
                customInput.focus();
                return;
            }
            
            if (jumlah > state.saldo) {
                alert(`Saldo tidak cukup! Saldo Anda: Rp ${state.saldo.toLocaleString()}`);
                customInput.value = state.saldo;
                customInput.focus();
                return;
            }
            
            jumlah = Math.floor(jumlah / 100) * 100;
            
            state.pasanganDipilih = jumlah;
            document.getElementById('status-pasangan').textContent = `Rp ${jumlah.toLocaleString()}`;
            
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('confirm-btn').disabled = false;
        }

        function setAllIn() {
            if (state.pasanganDipilih || state.last5Seconds) return;
            if (state.saldo < 100) {
                alert('Saldo minimal Rp 100 untuk bermain!');
                return;
            }
            
            state.pasanganDipilih = state.saldo;
            document.getElementById('status-pasangan').textContent = `Rp ${state.saldo.toLocaleString()}`;
            
            document.querySelectorAll('.pasangan-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            customInput.value = '';
            
            document.getElementById('confirm-btn').disabled = false;
        }

        async function konfirmasiPasangan() {
            if (!state.pasanganDipilih || state.angkaDipilih === null || !state.roundId || state.last5Seconds) {
                alert('Pilih angka dan pasangan terlebih dahulu!');
                return;
            }

            try {
                state.taruhanRef = database.ref(`tebak-angka/taruhan/${state.roundId}/taruhan_users/${state.userId}`);
                
                const taruhanData = {
                    user_id: state.userId,
                    pasangan: state.pasanganDipilih,
                    angka_tebakan: state.angkaDipilih,
                    status: 'menunggu',
                    waktu_taruhan: Date.now(),
                    hasil: null
                };
                
                await state.taruhanRef.set(taruhanData);
                
                state.bisaMemilih = false;
                
                closeBottomSheet();
                
                disableAllButtons();
                
                console.log('Taruhan berhasil disimpan ke Firebase');
            } catch (error) {
                console.error('Error menyimpan taruhan:', error);
                alert('Gagal menyimpan taruhan, coba lagi!');
                
                state.pasanganDipilih = null;
                document.getElementById('status-pasangan').textContent = '-';
            }
        }

        function disableAllButtons() {
            document.querySelectorAll('.angka-btn').forEach(btn => {
                btn.disabled = true;
            });
        }

        function startTimer() {
            clearInterval(state.timerInterval);
            state.last5Seconds = false;
            state.countdownPlayed = false;
            document.getElementById('timer').textContent = state.timer;
            document.getElementById('timer').classList.remove('shake');
            document.getElementById('timer').style.color = '';
            document.getElementById('timer').style.textShadow = '';
            
            state.timerInterval = setInterval(async () => {
                state.timer--;
                document.getElementById('timer').textContent = state.timer;
                
                if (state.timer <= 5 && state.timer > 0) {
                    if (!state.last5Seconds) {
                        state.last5Seconds = true;
                        showLast5SecondsWarning();
                        
                        if (!state.countdownPlayed && audioInitialized && state.audioEnabled) {
                            playCountdownAudio();
                            state.countdownPlayed = true;
                        } else {
                            document.getElementById('timer').style.color = '#ff0000';
                            document.getElementById('timer').style.textShadow = '0 0 10px #ff0000';
                        }
                        
                        if (state.bisaMemilih) {
                            disableAllButtons();
                            closeBottomSheet();
                        }
                    }
                    
                    document.getElementById('timer').classList.add('pulse');
                }
                
                if (state.timer <= 3) {
                    document.getElementById('timer').classList.add('shake');
                }
                
                if (state.timer <= 0) {
                    clearInterval(state.timerInterval);
                    await waktuHabis();
                }
            }, 1000);
        }

        function playCountdownAudio() {
            if (!state.audioEnabled || !audioInitialized) {
                console.log("Audio disabled or not initialized");
                return;
            }
            
            try {
                countdownAudio.currentTime = 0;
                countdownAudio.volume = 0.5;
                
                const playPromise = countdownAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(e => {
                        console.log("Audio play failed:", e.name);
                    });
                }
            } catch (error) {
                console.log("Play audio error:", error);
            }
        }

        function showLast5SecondsWarning() {
            const warning = document.getElementById('last5-warning');
            warning.style.display = 'block';
            warning.classList.add('shake');
            
            setTimeout(() => {
                warning.style.display = 'none';
                warning.classList.remove('shake');
            }, 3000);
        }

        async function waktuHabis() {
            try {
                document.getElementById('timer').textContent = "HASIL...";
                
                console.log("‚è≥ Menunggu hasil dari admin panel...");
                
                const hasilListener = state.roundRef.on('value', (snapshot) => {
                    if (!snapshot.exists()) return;
                    
                    const roundData = snapshot.val();
                    
                    if (roundData.status === 'selesai' && roundData.hasil_angka !== null) {
                        state.roundRef.off('value', hasilListener);
                        processRoundResultFromAdmin(roundData.hasil_angka);
                    }
                });
                
                setTimeout(() => {
                    state.roundRef.off('value', hasilListener);
                    console.log("Timeout menunggu hasil dari admin");
                    findOrCreateRound();
                }, 10000);
            } catch (error) {
                console.error("Error waktu habis:", error);
                setTimeout(() => findOrCreateRound(), 2000);
            }
        }

        async function processRoundResultFromAdmin(hasilAngka) {
            if (state.processingResult) return;
            state.processingResult = true;
            
            try {
                const taruhanSnapshot = await database.ref(`tebak-angka/taruhan/${state.roundId}/taruhan_users/${state.userId}`).once('value');
                
                if (!taruhanSnapshot.exists()) {
                    console.log("User tidak ikut taruhan di round ini");
                    findOrCreateRound();
                    return;
                }
                
                const taruhanData = taruhanSnapshot.val();
                
                const menang = taruhanData.angka_tebakan === hasilAngka;
                const saldoNetto = menang ? taruhanData.pasangan : -taruhanData.pasangan;
                
                await database.ref(`tebak-angka/taruhan/${state.roundId}/taruhan_users/${state.userId}`).update({
                    status: menang ? 'menang' : 'kalah',
                    hasil: menang ? 'MENANG' : 'KALAH',
                    waktu_hasil: Date.now(),
                    saldo_netto: saldoNetto
                });
                
                console.log(`üìä User ${state.userId.substring(0, 8)}...: Menang=${menang}, Netto=${saldoNetto}`);
                
                findOrCreateRound();
                
            } catch (error) {
                console.error("Error process round result from admin:", error);
                setTimeout(() => findOrCreateRound(), 2000);
            }
        }

        function updateHasilRoundUI(hasilRoundData) {
            const container = document.getElementById('hasil-round-list');
            if (!hasilRoundData) {
                container.innerHTML = '<div class="hasil-round-item">üîÑ Menunggu hasil round...</div>';
                return;
            }
            
            let html = '';
            const items = Object.values(hasilRoundData)
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10);
            
            if (items.length === 0) {
                html = '<div class="hasil-round-item">üîÑ Menunggu hasil round...</div>';
            } else {
                items.forEach(item => {
                    const roundId = item.round_id || 'Unknown Round';
                    const angka = item.hasil_angka !== undefined ? `${item.hasil_angka}` : '?';
                    
                    html += `
                        <div class="hasil-round-item angka">
                            ${roundId} - Hasil: <strong>${angka}</strong> üî¢
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        function updateSaldo() {
            const saldoElement = document.getElementById('saldo');
            saldoElement.textContent = `Rp ${state.saldo.toLocaleString()}`;
            
            if (state.saldo < 0) {
                saldoElement.style.color = '#dc3545';
            } else {
                saldoElement.style.color = '#0066cc';
            }
            
            updateAllInButton();
        }

        function toggleAudio() {
            state.audioEnabled = !state.audioEnabled;
            const audioBtn = document.querySelector('.audio-btn');
            audioBtn.textContent = state.audioEnabled ? 'üîä' : 'üîá';
            
            if (state.audioEnabled && !audioInitialized) {
                unlockAudio();
            }
        }

        function unlockAudio() {
            if (audioUnlockAttempted) return;
            
            audioUnlockAttempted = true;
            console.log("Attempting to unlock audio...");
            
            countdownAudio.volume = 0;
            
            const playPromise = countdownAudio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log(`Audio initialized successfully`);
                    countdownAudio.pause();
                    countdownAudio.currentTime = 0;
                    countdownAudio.volume = 0.5;
                    audioInitialized = true;
                }).catch(e => {
                    console.log(`Audio initialization failed:`, e);
                    audioInitialized = true;
                });
            }
            
            setTimeout(() => {
                if (!audioInitialized) {
                    audioInitialized = true;
                    console.log("Audio unlocked via fallback");
                }
            }, 1000);
        }

        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
        }

        window.resetSaldo = async function() {
            if (confirm("Reset saldo ke Rp 50,000?")) {
                await database.ref('tebak-angka/saldo/' + state.userId).set(50000);
                state.saldo = 50000;
                updateSaldo();
            }
        };
    </script>
</body>

</html>
